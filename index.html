<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowState Pro - Student Productivity</title>
    <meta name="description" content="A free, Apple-inspired productivity app for students with task management, AI chat, and focus timer">
    
    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <meta name="theme-color" content="#007AFF">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #F2F2F7;
            --bg-secondary: rgba(255, 255, 255, 0.85);
            --text-primary: #1D1D1F;
            --text-secondary: #6E6E73;
            --primary-color: #007AFF;
            --success-color: #34C759;
            --danger-color: #FF3B30;
            --border-color: rgba(60, 60, 67, 0.1);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --card-bg: rgba(255, 255, 255, 0.92);
            --sidebar-bg: rgba(242, 242, 247, 0.95);
        }

        [data-theme="dark"] {
            --bg-primary: #1C1C1E;
            --bg-secondary: rgba(28, 28, 30, 0.9);
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --primary-color: #0A84FF;
            --border-color: rgba(84, 84, 88, 0.3);
            --card-bg: rgba(28, 28, 30, 0.92);
            --sidebar-bg: rgba(28, 28, 30, 0.95);
        }

        [data-theme="elegant"] {
            --bg-primary: linear-gradient(135deg, #5856D6 0%, #007AFF 100%);
            --primary-color: #5856D6;
            --text-primary: #FFFFFF;
            --text-secondary: #D1D1D6;
            --card-bg: rgba(255, 255, 255, 0.9);
            --sidebar-bg: rgba(88, 86, 214, 0.95);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            max-width: 1600px;
            margin: 16px auto;
            gap: 16px;
        }

        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 16px;
            height: calc(100vh - 32px);
            overflow-y: auto;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .app-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), #5856D6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .app-name {
            font-size: 24px;
            font-weight: 700;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary-color);
            color: white;
        }

        .main-content {
            flex: 1;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-modal.hidden {
            display: none;
        }

        .auth-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-input {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
        }

        .auth-btn {
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .auth-error {
            color: var(--danger-color);
            font-size: 13px;
            margin-top: 8px;
            min-height: 20px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .chat-messages {
            height: 240px;
            overflow-y: auto;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }

        .message {
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            max-width: 80%;
            font-size: 14px;
        }

        .message.user {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
        }

        .message.ai {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .voice-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .voice-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .voice-btn.listening {
            background: var(--danger-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .integrations-section {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .integration-btn {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .integration-btn.connected {
            background: var(--success-color);
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .timer-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .timer-btn {
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .timer-btn.active {
            background: var(--danger-color);
        }

        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }
            .card {
                padding: 16px;
            }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Authentication Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-content">
            <h2 id="authTitle">Welcome to FlowState Pro</h2>
            <p id="authSubtitle">Sign in to your account</p>
            <form class="auth-form" id="authForm">
                <input type="text" class="auth-input" id="nameInput" placeholder="Full Name" style="display: none;">
                <input type="email" class="auth-input" id="emailInput" placeholder="Email Address" required>
                <input type="password" class="auth-input" id="passwordInput" placeholder="Password" required>
                <input type="password" class="auth-input" id="confirmPasswordInput" placeholder="Confirm Password" style="display: none;">
                <button type="submit" class="auth-btn" id="authSubmitBtn">Sign In</button>
                <div class="auth-error" id="authError"></div>
            </form>
            <p style="margin-top: 16px; font-size: 13px;">
                <span id="authSwitchText">Don't have an account?</span>
                <a href="#" id="authSwitchLink" onclick="toggleAuthMode()">Sign Up</a>
            </p>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-logo">FS</div>
                <div class="app-name">FlowState Pro</div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item active" data-section="dashboard">üìä Dashboard</div>
                <div class="nav-item" data-section="tasks">üìã Tasks</div>
                <div class="nav-item" data-section="assistant">üß† AI Assistant</div>
                <div class="nav-item" data-section="focus">‚è∞ Focus Timer</div>
                <div class="nav-item" data-section="integrations">üîó Integrations</div>
                <div class="nav-item" data-section="settings">‚öôÔ∏è Settings</div>
                <div class="nav-item" onclick="userManager.logout()">üö™ Sign Out</div>
            </div>
            <div class="user-profile" style="margin-top: auto; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                <div class="user-avatar" id="userAvatar">U</div>
                <div id="userName">User</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div class="section" id="dashboard-section">
                <div class="card">
                    <div class="card-title">Welcome, <span id="welcomeName">User</span>!</div>
                    <div class="card-subtitle">Your student productivity companion</div>
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-style: italic; font-size: 16px; margin-bottom: 8px;" id="quoteText">"The way to get started is to quit talking and begin doing."</div>
                        <div style="font-weight: 500; color: var(--primary-color);" id="quoteAuthor">‚Äî Walt Disney</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Daily Progress</div>
                        <div style="text-align: center; padding: 16px;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                            </div>
                            <div style="font-size: 16px; font-weight: 600; color: var(--primary-color);" id="progressPercent">0%</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Complete</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Section -->
            <div class="section hidden" id="tasks-section">
                <div class="card">
                    <div class="card-title">Smart Task Creator</div>
                    <div class="card-subtitle">Create tasks with AI or voice</div>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <input type="text" class="input-field" id="taskInput" placeholder="Describe your task (e.g., Study Math - 7:00 PM)">
                        <button class="btn btn-primary" onclick="createTask()">Create</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Today's Tasks</div>
                    <div class="card-subtitle" id="tasksSummary">No tasks yet</div>
                    <div id="tasksList"></div>
                </div>
            </div>

            <!-- AI Assistant Section -->
            <div class="section hidden" id="assistant-section">
                <div class="card">
                    <div class="card-title">AI Study Buddy</div>
                    <div class="card-subtitle">Your personal study coach</div>
                    <div class="voice-controls">
                        <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">üé§</button>
                        <select id="voiceGender" onchange="updateVoice()">
                            <option value="female">Female Voice</option>
                            <option value="male">Male Voice</option>
                        </select>
                        <div id="voiceStatus">Voice ready</div>
                    </div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="input-field" id="chatInput" placeholder="Ask me anything...">
                        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="quickAction('progress')">üìä Progress</button>
                        <button class="btn btn-secondary" onclick="quickAction('tips')">üí° Study Tips</button>
                        <button class="btn btn-secondary" onclick="quickAction('motivation')">üöÄ Motivate</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Ask Your Doubts</div>
                    <div class="card-subtitle">Get instant study help</div>
                    <textarea class="input-field" id="doubtInput" placeholder="Ask any question (e.g., How to solve quadratic equations?)..." style="height: 80px; resize: vertical;"></textarea>
                    <div style="margin-top: 12px;">
                        <button class="btn btn-primary" onclick="resolveDoubt()">üß† Get AI Help</button>
                    </div>
                    <div id="doubtResponse" style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; display: none;"></div>
                </div>
            </div>

            <!-- Focus Timer Section -->
            <div class="section hidden" id="focus-section">
                <div class="card">
                    <div class="card-title">Focus Timer</div>
                    <div class="card-subtitle">Boost productivity with Pomodoro</div>
                    <div class="timer-controls">
                        <div style="font-size: 24px; font-weight: 600;" id="timerDisplay">25:00</div>
                        <button class="timer-btn" id="timerStartBtn" onclick="toggleTimer()">Start</button>
                        <button class="btn btn-secondary" onclick="resetTimer()">Reset</button>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Work for 25 minutes, then take a 5-minute break!</div>
                </div>
            </div>

            <!-- Integrations Section -->
            <div class="section hidden" id="integrations-section">
                <div class="card">
                    <div class="card-title">App Integrations</div>
                    <div class="card-subtitle">Connect your study tools</div>
                    <div class="integrations-section">
                        <button class="integration-btn" id="zoomBtn" onclick="connectApp('zoom')">üìπ Zoom</button>
                        <button class="integration-btn" id="teamsBtn" onclick="connectApp('teams')">üí¨ Teams</button>
                        <button class="integration-btn" id="googleCalendarBtn" onclick="connectApp('googleCalendar')">üìÖ Google Calendar</button>
                        <button class="integration-btn" id="outlookBtn" onclick="connectApp('outlook')">üìß Outlook</button>
                        <button class="integration-btn" id="slackBtn" onclick="connectApp('slack')">üì¢ Slack</button>
                    </div>
                    <div id="integrationStatus" style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);"></div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="section hidden" id="settings-section">
                <div class="card">
                    <div class="card-title">Settings</div>
                    <div class="card-subtitle">Customize your experience</div>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button class="btn btn-secondary active" onclick="setTheme('light')">Light</button>
                        <button class="btn btn-secondary" onclick="setTheme('dark')">Dark</button>
                        <button class="btn btn-secondary" onclick="setTheme('elegant')">Elegant</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let tasks = [];
        let isLoggedIn = false;
        let isListening = false;
        let selectedVoice = null;
        let recognition = null;
        let timerInterval = null;
        let timerSeconds = 25 * 60;
        let isTimerRunning = false;
        let integrations = {
            zoom: false,
            teams: false,
            googleCalendar: false,
            outlook: false,
            slack: false
        };

        // Student-Focused Quotes
        const quotes = {
            motivation: [
                { text: "The way to get started is to quit talking and begin doing.", author: "Walt Disney" },
                { text: "Study hard, dream big, and never give up!", author: "Student Proverb" },
                { text: "Every small step in your studies is a leap toward your future.", author: "Anonymous" }
            ],
            superhero: [
                { text: "With great knowledge comes great responsibility.", author: "Inspired by Spider-Man" },
                { text: "Be the hero of your own study journey!", author: "FlowState Pro" }
            ]
        };

        // Utility to Hash Passwords
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // User Management
        class UserManager {
            constructor() {
                this.currentUser = null;
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    this.currentUser = JSON.parse(storedUser);
                    this.login(this.currentUser);
                } else {
                    this.showAuth();
                }
            }

            showAuth() {
                document.getElementById('authModal').classList.remove('hidden');
                document.getElementById('authError').textContent = '';
            }

            hideAuth() {
                document.getElementById('authModal').classList.add('hidden');
            }

            async loginWithEmail(email, password) {
                if (!email || !password) {
                    document.getElementById('authError').textContent = 'Please enter both email and password.';
                    return;
                }
                const hashedPassword = await hashPassword(password);
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const user = users[email];
                if (!user) {
                    document.getElementById('authError').textContent = 'No account found with this email.';
                    return;
                }
                if (user.password !== hashedPassword) {
                    document.getElementById('authError').textContent = 'Incorrect password.';
                    return;
                }
                this.login({
                    id: email,
                    name: user.name,
                    email: email,
                    tasks: user.tasks || [],
                    preferences: user.preferences || { theme: 'light', voice: 'female' }
                });
            }

            async register(name, email, password, confirmPassword) {
                if (!name || !email || !password) {
                    document.getElementById('authError').textContent = 'Please fill in all fields.';
                    return;
                }
                if (password !== confirmPassword) {
                    document.getElementById('authError').textContent = 'Passwords do not match.';
                    return;
                }
                if (password.length < 6) {
                    document.getElementById('authError').textContent = 'Password must be at least 6 characters.';
                    return;
                }
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                if (users[email]) {
                    document.getElementById('authError').textContent = 'Email already in use.';
                    return;
                }
                const hashedPassword = await hashPassword(password);
                users[email] = {
                    name,
                    password: hashedPassword,
                    tasks: [],
                    preferences: { theme: 'light', voice: 'female' }
                };
                localStorage.setItem('users', JSON.stringify(users));
                this.login({
                    id: email,
                    name,
                    email,
                    tasks: [],
                    preferences: { theme: 'light', voice: 'female' }
                });
            }

            login(user) {
                this.currentUser = user;
                currentUser = user;
                isLoggedIn = true;
                tasks = user.tasks || [];
                localStorage.setItem('currentUser', JSON.stringify(user));
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
                document.getElementById('welcomeName').textContent = user.name;
                this.hideAuth();
                renderTasks();
                setTheme(user.preferences.theme);
                document.getElementById('voiceGender').value = user.preferences.voice;
                updateVoice();
                addChatMessage(`Welcome, ${user.name}! Let's ace your studies today!`, 'ai');
                speakText(`Welcome back, ${user.name}! Ready to crush your studies?`);
            }

            logout() {
                localStorage.removeItem('currentUser');
                this.saveData();
                window.location.reload();
            }

            saveData() {
                if (this.currentUser) {
                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                    users[this.currentUser.email] = {
                        ...users[this.currentUser.email],
                        tasks,
                        preferences: this.currentUser.preferences
                    };
                    localStorage.setItem('users', JSON.stringify(users));
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                }
            }
        }

        const userManager = new UserManager();

        // Voice Management
        function initVoice() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('voiceBtn').classList.add('listening');
                    document.getElementById('voiceStatus').textContent = 'Listening...';
                };
                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('voiceBtn').classList.remove('listening');
                    document.getElementById('voiceStatus').textContent = 'Voice ready';
                };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    processVoiceCommand(transcript);
                };
                recognition.onerror = (event) => {
                    document.getElementById('voiceStatus').textContent = 'Voice recognition error';
                    console.error(event.error);
                };
            }
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = updateVoiceOptions;
                updateVoiceOptions();
            }
        }

        function updateVoiceOptions() {
            const voices = speechSynthesis.getVoices();
            const genderPref = document.getElementById('voiceGender').value;
            selectedVoice = voices.find(voice => {
                const name = voice.name.toLowerCase();
                return genderPref === 'female' ? 
                    name.includes('female') || name.includes('samantha') || name.includes('karen') :
                    name.includes('male') || name.includes('daniel') || name.includes('alex');
            }) || voices[0];
        }

        function speakText(text) {
            if ('speechSynthesis' in window && selectedVoice) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = selectedVoice;
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        function toggleVoice() {
            if (!recognition) {
                document.getElementById('voiceStatus').textContent = 'Voice not supported';
                return;
            }
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function processVoiceCommand(command) {
            document.getElementById('voiceStatus').textContent = `Heard: "${command}"`;
            if (command.toLowerCase().includes('create') || command.toLowerCase().includes('task')) {
                document.getElementById('taskInput').value = command;
                createTask();
            } else if (command.toLowerCase().includes('progress')) {
                quickAction('progress');
            } else if (command.toLowerCase().includes('start timer')) {
                toggleTimer();
            } else {
                document.getElementById('chatInput').value = command;
                sendMessage();
            }
        }

        function updateVoice() {
            updateVoiceOptions();
            if (currentUser) {
                currentUser.preferences.voice = document.getElementById('voiceGender').value;
                userManager.saveData();
            }
        }

        // Focus Timer
        function toggleTimer() {
            if (isTimerRunning) {
                clearInterval(timerInterval);
                document.getElementById('timerStartBtn').textContent = 'Start';
                document.getElementById('timerStartBtn').classList.remove('active');
                isTimerRunning = false;
                speakText('Timer stopped. Take a break or keep studying!');
            } else {
                timerInterval = setInterval(() => {
                    timerSeconds--;
                    if (timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        isTimerRunning = false;
                        document.getElementById('timerStartBtn').textContent = 'Start';
                        document.getElementById('timerStartBtn').classList.remove('active');
                        speakText('Great job! Time for a 5-minute break.');
                        timerSeconds = 25 * 60;
                    }
                    updateTimerDisplay();
                }, 1000);
                isTimerRunning = true;
                document.getElementById('timerStartBtn').textContent = 'Stop';
                document.getElementById('timerStartBtn').classList.add('active');
                speakText('Focus timer started. Let‚Äôs study!');
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            timerSeconds = 25 * 60;
            isTimerRunning = false;
            document.getElementById('timerStartBtn').textContent = 'Start';
            document.getElementById('timerStartBtn').classList.remove('active');
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Task Management
        function createTask() {
            const input = document.getElementById('taskInput');
            const message = input.value.trim();
            if (!message) return;
            input.value = '';
            addChatMessage(message, 'user');
            const response = aiAssistant.handleTaskCreation(message);
            addChatMessage(response, 'ai');
            speakText(`Task created! ${aiAssistant.getMotivation()}`);
        }

        function extractTaskFromText(message) {
            const match = message.match(/(.+?)(?:\s*-\s*(\d{1,2}:\d{2}\s*(?:am|pm))?)/i);
            const title = match ? match[1].trim() : message.trim() || 'New Task';
            const time = match && match[2] ? match[2] : '09:00';
            return {
                id: Date.now(),
                title: title.charAt(0).toUpperCase() + title.slice(1),
                time: time,
                completed: false,
                createdAt: new Date()
            };
        }

        // Integrations (Mocked)
        function connectApp(app) {
            integrations[app] = !integrations[app];
            updateIntegrationStatus();
            document.getElementById('integrationStatus').textContent = integrations[app] 
                ? `${app} connected (mock)` 
                : `${app} disconnected (mock)`;
            if (integrations[app]) {
                addChatMessage(`Synced tasks with ${app} (mock).`, 'ai');
                speakText(`Synced tasks with ${app}.`);
            }
        }

        function updateIntegrationStatus() {
            Object.keys(integrations).forEach(app => {
                const btn = document.getElementById(`${app}Btn`);
                btn.classList.toggle('connected', integrations[app]);
                btn.textContent = integrations[app] ? `‚úÖ ${app}` : `üîó ${app}`;
            });
        }

        // AI Assistant
        class AIAssistant {
            constructor() {
                this.motivationIndex = 0;
            }

            async processMessage(message) {
                if (this.isTaskRequest(message)) {
                    return this.handleTaskCreation(message);
                }
                if (message.toLowerCase().includes('progress')) {
                    return this.getProgressReport();
                }
                if (message.toLowerCase().includes('tip')) {
                    return this.getStudyTip();
                }
                if (message.toLowerCase().includes('motivat')) {
                    return this.getMotivation();
                }
                return this.getGeneralResponse(message);
            }

            isTaskRequest(message) {
                return /create|add|schedule|task|remind/i.test(message);
            }

            handleTaskCreation(message) {
                const task = extractTaskFromText(message);
                if (task.title) {
                    tasks.push(task);
                    renderTasks();
                    userManager.saveData();
                    const quote = this.getRandomQuote('motivation');
                    return `‚úÖ Task "${task.title}" created for ${task.time}!\n\nüí° "${quote.text}" ‚Äî ${quote.author}`;
                }
                return "Please provide more task details.";
            }

            getProgressReport() {
                const completed = tasks.filter(t => t.completed).length;
                const total = tasks.length;
                const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
                return `üìä Progress: ${completed}/${total} tasks\nüìà ${rate}%\n\n${this.getMotivationalMessage(rate)}`;
            }

            getStudyTip() {
                const tips = [
                    "üìö Break your study sessions into 25-minute chunks with 5-minute breaks.",
                    "üß† Summarize what you‚Äôve learned in your own words to retain it better.",
                    "üìù Take notes by hand to improve memory retention.",
                    "üì± Avoid phone distractions during study time.",
                    "üéØ Set specific goals for each study session."
                ];
                return tips[Math.floor(Math.random() * tips.length)];
            }

            getMotivation() {
                const motivations = [
                    `üåü ${currentUser?.name || 'Scholar'}, you're unstoppable!`,
                    `üí™ Keep pushing, ${currentUser?.name || 'Achiever'}!`,
                    `üöÄ ${currentUser?.name || 'Star'}, ace those exams!`
                ];
                this.motivationIndex = (this.motivationIndex + 1) % motivations.length;
                return motivations[this.motivationIndex];
            }

            getMotivationalMessage(rate) {
                if (rate >= 80) return `üéâ Amazing work, ${currentUser?.name || 'Scholar'}!`;
                if (rate >= 40) return `üí™ Solid progress, ${currentUser?.name || 'Fighter'}!`;
                return `üöÄ Keep studying, ${currentUser?.name || 'Explorer'}!`;
            }

            getGeneralResponse(message) {
                return `Hey ${currentUser?.name || 'friend'}, I'm here to help you study smarter! What's next?`;
            }

            getRandomQuote(category) {
                const quoteArray = quotes[category] || quotes.motivation;
                return quoteArray[Math.floor(Math.random() * quoteArray.length)];
            }

            displayQuote(category = 'motivation') {
                const quote = this.getRandomQuote(category);
                document.getElementById('quoteText').textContent = `"${quote.text}"`;
                document.getElementById('quoteAuthor').textContent = `‚Äî ${quote.author}`;
            }
        }

        const aiAssistant = new AIAssistant();

        // Doubt Resolution
        async function resolveDoubt() {
            const question = document.getElementById('doubtInput').value.trim();
            if (!question) return;
            const response = document.getElementById('doubtResponse');
            response.style.display = 'block';
            response.innerHTML = '<div>ü§î Thinking...</div>';
            setTimeout(() => {
                response.innerHTML = `
                    <div style="line-height: 1.5; font-size: 14px;">
                        <strong>üß† Study Buddy Response:</strong><br>
                        For "<em>${question}</em>":<br>
                        Try breaking it down into smaller parts and practice daily.<br>
                        <strong>Tip:</strong> Review related concepts or ask your teacher for clarification.<br>
                        <em>üí° Keep learning, ${currentUser?.name || 'student'}!</em>
                    </div>
                `;
                speakText('I found a study tip for your question.');
            }, 1500);
        }

        // UI Functions
        function toggleAuthMode() {
            const isLogin = document.getElementById('authTitle').textContent.includes('Sign In');
            document.getElementById('authTitle').textContent = isLogin ? 'Create Account' : 'Sign In';
            document.getElementById('nameInput').style.display = isLogin ? 'block' : 'none';
            document.getElementById('confirmPasswordInput').style.display = isLogin ? 'block' : 'none';
            document.getElementById('authSubmitBtn').textContent = isLogin ? 'Create Account' : 'Sign In';
            document.getElementById('authSwitchText').textContent = isLogin ? 'Already have an account?' : "Don't have an account?";
            document.getElementById('authSwitchLink').textContent = isLogin ? 'Sign In' : 'Sign Up';
            document.getElementById('authError').textContent = '';
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            addChatMessage(message, 'user');
            input.value = '';
            const response = await aiAssistant.processMessage(message);
            addChatMessage(response, 'ai');
            speakText(response.replace(/[üéØüí™üöÄ‚ö°üåüüìä‚úÖüìàüîÑüì±üß†]/g, ''));
        }

        function addChatMessage(message, sender) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.innerHTML = message.replace(/\n/g, '<br>');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            const summary = document.getElementById('tasksSummary');
            if (tasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 32px; color: var(--text-secondary);"><div style="font-size: 40px; margin-bottom: 8px;">üìù</div><div>Create your first task!</div></div>';
                summary.textContent = 'No tasks yet';
                updateProgress();
                return;
            }
            const completed = tasks.filter(t => t.completed).length;
            summary.textContent = `${completed}/${tasks.length} completed`;
            container.innerHTML = '';
            tasks.forEach(task => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;';
                div.innerHTML = `
                    <div style="width: 18px; height: 18px; border: 2px solid var(--primary-color); border-radius: 50%; cursor: pointer; ${task.completed ? 'background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center;' : ''}" onclick="toggleTask(${task.id})">
                        ${task.completed ? '‚úì' : ''}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">${task.title}</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">${task.time}</div>
                    </div>
                    <button onclick="removeTask(${task.id})" style="padding: 6px 12px; background: var(--danger-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">Remove</button>
                `;
                container.appendChild(div);
            });
            updateProgress();
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    const quote = aiAssistant.getRandomQuote('superhero');
                    addChatMessage(`üéâ Task done! "${quote.text}" ‚Äî ${quote.author}`, 'ai');
                    speakText(`Great job, ${currentUser?.name}! ${quote.text}`);
                }
                renderTasks();
                userManager.saveData();
            }
        }

        function removeTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            renderTasks();
            userManager.saveData();
        }

        function updateProgress() {
            const completed = tasks.filter(t => t.completed).length;
            const total = tasks.length;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progressFill').style.width = `${percentage}%`;
            document.getElementById('progressPercent').textContent = `${Math.round(percentage)}%`;
        }

        function quickAction(type) {
            const actions = {
                progress: 'Show my progress report',
                tips: 'Give me a study tip',
                motivation: 'I need motivation'
            };
            document.getElementById('chatInput').value = actions[type];
            sendMessage();
        }

        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.querySelectorAll('.btn-secondary').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === theme);
            });
            if (currentUser) {
                currentUser.preferences.theme = theme;
                userManager.saveData();
            }
        }

        // Authentication Handlers
        document.getElementById('authForm').addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            const isRegister = document.getElementById('nameInput').style.display !== 'none';
            const name = document.getElementById('nameInput').value.trim();
            const confirmPassword = document.getElementById('confirmPasswordInput').value.trim();
            document.getElementById('authError').textContent = '';

            if (isRegister) {
                await userManager.register(name, email, password, confirmPassword);
            } else {
                await userManager.loginWithEmail(email, password);
            }
        });

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initVoice();
            aiAssistant.displayQuote();
            document.getElementById('chatInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') sendMessage();
            });
            document.getElementById('taskInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') createTask();
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
                    document.getElementById(`${item.dataset.section}-section`).classList.remove('hidden');
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                });
            });
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    reg.update();
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                const banner = document.createElement('div');
                                banner.innerHTML = `
                                    <div style="position: fixed; bottom: 16px; left: 16px; right: 16px; background: var(--primary-color); color: white; padding: 12px; border-radius: 8px; text-align: center; z-index: 9999;">
                                        üÜï Update available! 
                                        <button onclick="updateApp()" style="margin-left: 8px; padding: 6px 12px; background: white; color: var(--primary-color); border: none; border-radius: 6px; font-weight: 500;">Update</button>
                                    </div>
                                `;
                                document.body.appendChild(banner);
                            }
                        });
                    });
                    navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
                }).catch(err => console.error('Service Worker registration failed:', err));
            });
        }

        function updateApp() {
            navigator.serviceWorker.getRegistration().then(reg => {
                if (reg && reg.waiting) {
                    reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                }
            });
        }
    </script>
</body>
</html>
