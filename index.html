<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowState Pro - Advanced AI Productivity Companion</title>
    <meta name="description" content="Advanced AI-powered productivity companion with smart task management, timers, and notifications">
    <meta name="theme-color" content="var(--primary-color)">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed');
                    });
            });
        }
    </script>
    
    <style>
        :root {
            /* Light Theme Variables */
            --bg-primary: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.8);
            --bg-tertiary: rgba(255, 255, 255, 0.7);
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-accent: #007AFF;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-primary: 0 8px 32px rgba(0, 0, 0, 0.1);
            --shadow-secondary: 0 4px 16px rgba(0, 0, 0, 0.04);
            --primary-color: #007AFF;
            --success-color: #30d158;
            --warning-color: #ff9500;
            --danger-color: #ff3b30;
            --card-bg: rgba(255, 255, 255, 0.7);
        }

        [data-theme="dark"] {
            /* Dark Theme Variables */
            --bg-primary: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            --bg-secondary: rgba(28, 28, 30, 0.8);
            --bg-tertiary: rgba(44, 44, 46, 0.7);
            --text-primary: #ffffff;
            --text-secondary: #98989d;
            --text-accent: #0a84ff;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-primary: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-secondary: 0 4px 16px rgba(0, 0, 0, 0.2);
            --primary-color: #0a84ff;
            --success-color: #32d74b;
            --warning-color: #ff9f0a;
            --danger-color: #ff453a;
            --card-bg: rgba(28, 28, 30, 0.7);
        }

        [data-theme="minimal"] {
            /* Minimal Theme Variables */
            --bg-primary: #fafafa;
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-tertiary: rgba(248, 249, 250, 0.9);
            --text-primary: #2c2c2c;
            --text-secondary: #757575;
            --text-accent: #4285f4;
            --border-color: rgba(0, 0, 0, 0.08);
            --shadow-primary: 0 2px 16px rgba(0, 0, 0, 0.06);
            --shadow-secondary: 0 1px 8px rgba(0, 0, 0, 0.03);
            --primary-color: #4285f4;
            --card-bg: rgba(255, 255, 255, 0.8);
        }

        [data-theme="elegant"] {
            /* Elegant Theme Variables */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.9);
            --bg-tertiary: rgba(255, 255, 255, 0.8);
            --text-primary: #2c2c54;
            --text-secondary: #6c5ce7;
            --text-accent: #a29bfe;
            --border-color: rgba(108, 92, 231, 0.2);
            --shadow-primary: 0 12px 40px rgba(108, 92, 231, 0.15);
            --shadow-secondary: 0 6px 20px rgba(108, 92, 231, 0.08);
            --primary-color: #6c5ce7;
            --card-bg: rgba(255, 255, 255, 0.85);
        }

        [data-theme="awesome"] {
            /* Awesome Theme Variables */
            --bg-primary: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --bg-secondary: rgba(255, 255, 255, 0.9);
            --bg-tertiary: rgba(255, 255, 255, 0.8);
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --text-accent: #e17055;
            --border-color: rgba(225, 112, 85, 0.2);
            --shadow-primary: 0 12px 40px rgba(255, 107, 107, 0.2);
            --shadow-secondary: 0 6px 20px rgba(255, 107, 107, 0.1);
            --primary-color: #e17055;
            --card-bg: rgba(255, 255, 255, 0.85);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            line-height: 1.47059;
            font-weight: 400;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-primary);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary-color), var(--text-accent));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .app-name {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.003em;
        }

        .app-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            margin-left: 4px;
            font-weight: 400;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .theme-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .theme-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .theme-btn:hover, .theme-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(52, 199, 89, 0.1);
            border-radius: 20px;
            color: var(--success-color);
            font-weight: 500;
            font-size: 14px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 40px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-secondary);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-primary);
        }

        .card-header {
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: var(--bg-secondary);
            transition: all 0.2s ease;
            font-family: inherit;
            color: var(--text-primary);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background: var(--bg-secondary);
        }

        .input-field::placeholder {
            color: var(--text-secondary);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            opacity: 0.8;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Timer Display Styles */
        .activity-timer {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-top: 8px;
        }

        .timer-display {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            min-width: 80px;
        }

        .timer-controls {
            display: flex;
            gap: 8px;
        }

        .timer-btn {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .timer-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .timer-btn.active {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        /* Study Alarm Styles */
        .study-alarm {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .alarm-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }

        .alarm-time {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Activity Item Enhanced */
        .task-item {
            display: flex;
            align-items: flex-start;
            flex-direction: column;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .task-item:hover {
            background: var(--card-bg);
            transform: translateX(4px);
            box-shadow: var(--shadow-secondary);
        }

        .task-item.completed {
            background: rgba(52, 199, 89, 0.1);
            border-color: var(--success-color);
        }

        .task-main {
            display: flex;
            align-items: center;
            width: 100%;
            margin-bottom: 8px;
        }

        .task-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            margin-right: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .task-checkbox:hover {
            transform: scale(1.1);
        }

        .task-checkbox.checked {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .task-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 16px;
        }

        .task-meta {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        /* Notification Styles */
        .notification-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .notification-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .notification-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-primary);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .notification-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .notification-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .notification-body {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .notification-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        /* Install Prompt Styles */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 122, 255, 0.3);
            z-index: 1500;
            display: none;
            max-width: 400px;
            text-align: center;
        }

        .install-prompt.show {
            display: block;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .install-content {
            margin-bottom: 16px;
        }

        .install-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .install-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .install-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .install-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .install-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .install-btn.primary {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary-color);
        }

        .install-btn.primary:hover {
            background: white;
        }

        /* Study Mode Indicator */
        .study-mode-active {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--warning-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1100;
            display: none;
            animation: pulse 2s infinite;
        }

        .study-mode-active.show {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .theme-selector {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 20px;
            }
            
            .header-controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .input-group {
                flex-direction: column;
            }

            .notification-content {
                margin: 20px;
            }
        }

        /* Additional theme-specific styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-secondary);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .progress-ring {
            width: 100px;
            height: 100px;
            margin: 20px auto;
            position: relative;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
        }

        .progress-ring .background {
            stroke: var(--border-color);
        }

        .progress-ring .progress {
            stroke: var(--primary-color);
            stroke-dasharray: 251;
            stroke-dashoffset: 251;
            transition: stroke-dashoffset 0.5s ease;
        }

        .chart-container {
            position: relative;
            height: 180px;
            margin: 20px 0;
        }

        .ai-chat-container {
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            margin-right: auto;
        }

        .message.system {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
            text-align: center;
            margin: 8px auto;
            font-size: 14px;
            font-weight: 500;
        }

        .typing-indicator {
            display: none;
            padding: 8px 16px;
            color: var(--text-secondary);
            font-style: italic;
            font-size: 14px;
        }

        .typing-indicator.show {
            display: block;
        }

        .quick-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .quick-action {
            padding: 6px 12px;
            background: var(--border-color);
            border: none;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
            font-weight: 500;
        }

        .quick-action:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            color: var(--text-primary);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow-primary);
            z-index: 1000;
            border: 1px solid var(--border-color);
            display: none;
            animation: slideIn 0.3s ease;
        }

        .notification.show {
            display: block;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .creation-mode {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .mode-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 15px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }
    </style>
</head>
<body data-theme="light">
    <!-- Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <div class="install-content">
            <div class="install-title">üì± Install FlowState Pro</div>
            <div class="install-subtitle">Get the full app experience with offline access and notifications</div>
        </div>
        <div class="install-actions">
            <button class="install-btn primary" onclick="installApp()">Install Now</button>
            <button class="install-btn" onclick="dismissInstall()">Maybe Later</button>
            <button class="install-btn" onclick="dismissInstall()">√ó</button>
        </div>
    </div>

    <!-- Study Mode Indicator -->
    <div class="study-mode-active" id="studyModeIndicator">
        üìö Study Mode Active
    </div>

    <!-- Activity Notification Modal -->
    <div class="notification-modal" id="activityNotification">
        <div class="notification-content">
            <div class="notification-icon">‚è∞</div>
            <div class="notification-title" id="notificationTitle">Time for Your Activity!</div>
            <div class="notification-body" id="notificationBody">It's time to start your scheduled task.</div>
            <div class="notification-actions">
                <button class="btn btn-primary" onclick="startActivityTimer()">Start Timer</button>
                <button class="btn btn-secondary" onclick="snoozeActivity(5)">Snooze 5min</button>
                <button class="btn btn-secondary" onclick="snoozeActivity(10)">Snooze 10min</button>
                <button class="btn btn-secondary" onclick="dismissActivityNotification()">Skip</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- App Header -->
        <div class="app-header">
            <div class="app-title">
                <div class="app-logo">FS</div>
                <div>
                    <div class="app-name">FlowState Pro</div>
                    <div class="app-subtitle">Advanced AI Productivity Companion</div>
                </div>
            </div>
            <div class="header-controls">
                <div class="theme-selector">
                    <button class="theme-btn active" data-theme="light" onclick="setTheme('light')">Light</button>
                    <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')">Dark</button>
                    <button class="theme-btn" data-theme="minimal" onclick="setTheme('minimal')">Minimal</button>
                    <button class="theme-btn" data-theme="elegant" onclick="setTheme('elegant')">Elegant</button>
                    <button class="theme-btn" data-theme="awesome" onclick="setTheme('awesome')">Awesome</button>
                </div>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>AI Model Active</span>
                </div>
            </div>
        </div>

        <!-- Study Alarm Section -->
        <div class="study-alarm">
            <div class="card-title">üìö Study Alarm</div>
            <div class="card-subtitle">Set focused study sessions with break reminders</div>
            <div class="alarm-controls">
                <div class="alarm-time">
                    <label for="studyStartTime" class="sr-only">Study Start Time</label>
                    <input type="time" id="studyStartTime" name="studyStartTime" class="input-field" style="width: 120px;">
                    <span>for</span>
                    <label for="studyDuration" class="sr-only">Study Duration</label>
                    <select id="studyDuration" name="studyDuration" class="input-field" style="width: 100px;">
                        <option value="25">25 min</option>
                        <option value="45">45 min</option>
                        <option value="60">1 hour</option>
                        <option value="90">1.5 hours</option>
                        <option value="120">2 hours</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-small" onclick="setStudyAlarm()">Set Study Alarm</button>
                <button class="btn btn-secondary btn-small" onclick="stopStudyAlarm()" id="stopStudyBtn" style="display: none;">Stop Alarm</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Task Creation -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Create New Task</div>
                        <div class="card-subtitle">Add tasks manually or use advanced AI assistance</div>
                    </div>
                    
                    <div class="creation-mode">
                        <label for="creationModeToggle" class="mode-label">Mode:</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="creationModeToggle" name="creationMode" onchange="toggleCreationMode()">
                            <span class="slider"></span>
                        </label>
                        <span id="modeText">Manual</span>
                    </div>

                    <!-- Manual Mode -->
                    <div id="manualMode">
                        <div class="input-group">
                            <label for="taskTitle" class="sr-only">Task Name</label>
                            <input type="text" class="input-field" id="taskTitle" name="taskTitle" placeholder="Task name">
                            
                            <label for="taskTime" class="sr-only">Task Time</label>
                            <input type="time" class="input-field" id="taskTime" name="taskTime" style="flex: 0 0 140px;">
                            
                            <label for="taskDuration" class="sr-only">Task Duration</label>
                            <select class="input-field" id="taskDuration" name="taskDuration" style="flex: 0 0 100px;">
                                <option value="15">15m</option>
                                <option value="30">30m</option>
                                <option value="45">45m</option>
                                <option value="60" selected>1h</option>
                                <option value="90">1.5h</option>
                                <option value="120">2h</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="createTaskManual()">
                            <span>+</span> Create Task
                        </button>
                    </div>

                    <!-- AI Mode -->
                    <div id="aiMode" style="display: none;">
                        <div class="input-group">
                            <label for="aiTaskInput" class="sr-only">AI Task Description</label>
                            <input type="text" class="input-field" id="aiTaskInput" name="aiTaskInput" placeholder="E.g., 'Exercise at 6 PM for 1 hour' or 'Read for 30 minutes at 8 AM'">
                            <button class="btn btn-primary" onclick="createTaskAI()">
                                <span>ü§ñ</span> Create
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Today's Tasks -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Today's Tasks</div>
                        <div class="card-subtitle" id="tasksSummary">No tasks scheduled</div>
                    </div>
                    <div id="tasksList"></div>
                </div>

                <!-- Progress Analytics -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Analytics</div>
                        <div class="card-subtitle">Your productivity insights</div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="completionRate">0%</div>
                            <div class="stat-label">Completion</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTime">0h</div>
                            <div class="stat-label">Time Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="streakCount">0</div>
                            <div class="stat-label">Streak</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTasks">0</div>
                            <div class="stat-label">Total Tasks</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- AI Assistant -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">AI Assistant</div>
                        <div class="card-subtitle">Your intelligent productivity coach</div>
                    </div>
                    
                    <div class="ai-chat-container">
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="typing-indicator" id="typingIndicator">AI is thinking...</div>
                        <div class="input-group">
                            <label for="chatInput" class="sr-only">Chat Message</label>
                            <input type="text" class="input-field" id="chatInput" name="chatInput" placeholder="Ask me anything...">
                            <button class="btn btn-primary btn-small" onclick="sendMessage()">Send</button>
                        </div>
                        <div class="quick-actions">
                            <button class="quick-action" onclick="quickAction('progress')">üìä Progress</button>
                            <button class="quick-action" onclick="quickAction('tips')">üí° Tips</button>
                            <button class="quick-action" onclick="quickAction('motivation')">üöÄ Motivate</button>
                        </div>
                    </div>
                </div>

                <!-- Daily Progress -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Daily Progress</div>
                        <div class="card-subtitle">Your productivity overview</div>
                    </div>
                    
                    <div class="progress-ring">
                        <svg>
                            <circle class="background" cx="50" cy="50" r="40"></circle>
                            <circle class="progress" cx="50" cy="50" r="40" id="progressCircle"></circle>
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 20px; font-weight: 600;" id="progressPercent">0%</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Complete</div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 16px;">
                        <div style="font-size: 16px; font-weight: 500;" id="dailyMessage">Ready to start!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Enhanced Application State
        let tasks = [];
        let completedTasks = [];
        let isAIMode = false;
        let progressChart = null;
        let currentTheme = 'light';
        let activeTimers = new Map();
        let studyAlarmTimeout = null;
        let studyModeActive = false;
        let deferredPrompt = null;

        // Advanced AI with Enhanced Natural Language Processing
        class UltraAdvancedAI {
            constructor() {
                this.context = [];
                this.learningPatterns = new Map();
                this.userPreferences = {
                    preferredTimes: [],
                    commonActivities: [],
                    productivityPeaks: []
                };
                
                this.advancedPatterns = {
                    taskCreation: [
                        /(?:create|add|schedule|make|set(?:\s+up)?|plan|organize|arrange)\s+(?:a\s+)?(?:task|activity|reminder|appointment|session|event)?\s*(?:to\s+|for\s+)?([^,]+?)(?:\s+(?:at|from|starting|beginning)\s+)(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m)(?:\s+(?:for|lasting|duration)\s+)?(?:(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr))?/i,
                        /(?:i\s+(?:want|need|would\s+like|plan)\s+to\s+|let\s+me\s+|help\s+me\s+|remind\s+me\s+to\s+)([^,]+?)(?:\s+(?:at|around|by)\s+)(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m)(?:\s+(?:for|lasting)\s+)?(?:(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr))?/i,
                        /([^,]+?)\s+(?:at|from|starting|@)\s+(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m)(?:\s+(?:for|lasting)\s+)?(?:(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr))?/i,
                        /(?:at|from|starting|@)\s+(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m)(?:\s+(?:i\s+)?(?:want|need|would\s+like|plan)\s+to\s+|,?\s*)([^,]+?)(?:\s+(?:for|lasting)\s+)?(?:(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr))?/i,
                        /(?:(?:for|lasting)\s+)?(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr)\s+(?:of\s+)?([^,]+?)(?:\s+(?:at|starting|from)\s+)(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m)/i
                    ],
                    studySession: [
                        /study|learn|read|review|research|practice|homework|assignment/i
                    ],
                    workSession: [
                        /work|meeting|call|project|coding|writing|email|presentation/i
                    ],
                    wellness: [
                        /exercise|workout|meditation|yoga|walk|run|gym|fitness|health/i
                    ]
                };

                this.motivationalResponses = {
                    study: [
                        "üß† **Study Power!** Knowledge is the best investment you can make in yourself!",
                        "üìö **Learning Mode Activated!** Every minute of study builds your future success!",
                        "üéì **Academic Excellence!** You're developing skills that will serve you for life!",
                        "‚ö° **Mental Growth!** Your brain is like a muscle - the more you use it, the stronger it gets!"
                    ],
                    work: [
                        "üíº **Professional Excellence!** You're building the career of your dreams!",
                        "üöÄ **Career Momentum!** Every task completed moves you closer to your goals!",
                        "üéØ **Work Focus!** Your dedication today creates opportunities tomorrow!",
                        "üí™ **Achievement Mindset!** You're turning challenges into victories!"
                    ],
                    wellness: [
                        "üèÉ‚Äç‚ôÇÔ∏è **Health Hero!** Taking care of your body is taking care of your future!",
                        "üíö **Wellness Warrior!** Every healthy choice compounds into amazing results!",
                        "üåü **Energy Boost!** Physical activity fuels both body and mind!",
                        "üßò‚Äç‚ôÄÔ∏è **Mind-Body Connection!** You're investing in your complete well-being!"
                    ],
                    general: [
                        "üî• **Unstoppable Energy!** You're creating positive momentum in every area of life!",
                        "‚≠ê **Excellence in Action!** Your commitment to growth is truly inspiring!",
                        "üåà **Life Designer!** You're actively creating the life you want to live!",
                        "üíé **Personal Development!** Every task completed is a step toward your best self!"
                    ]
                };
            }

            async processMessage(message) {
                console.log('Processing advanced message:', message);
                this.context.push({ message, timestamp: new Date() });
                this.learnFromInput(message);

                // Enhanced task creation with context awareness
                const taskResult = await this.attemptAdvancedTaskCreation(message);
                if (taskResult.success) {
                    return taskResult.response;
                }

                // Enhanced progress analysis
                if (this.matchesPattern(message, ['progress', 'stats', 'analytics', 'report', 'summary'])) {
                    return this.generateAdvancedProgressReport();
                }

                // Enhanced tips with personalization
                if (this.matchesPattern(message, ['tip', 'advice', 'suggest', 'help', 'improve', 'productiv'])) {
                    return this.generatePersonalizedTip();
                }

                // Enhanced motivation with context
                if (this.matchesPattern(message, ['motivat', 'encourag', 'inspir', 'boost', 'cheer', 'energy'])) {
                    return this.generateContextualMotivation();
                }

                // Theme and customization requests
                if (this.matchesPattern(message, ['theme', 'color', 'appearance', 'mode', 'style'])) {
                    return this.handleThemeRequest(message);
                }

                return this.generateIntelligentResponse(message);
            }

            learnFromInput(message) {
                // Extract time patterns
                const timeMatches = message.match(/\d{1,2}(?::\d{2})?(?:\s*[ap]m)?/gi);
                if (timeMatches) {
                    timeMatches.forEach(time => {
                        this.userPreferences.preferredTimes.push(time);
                    });
                }

                // Extract activity patterns
                const words = message.toLowerCase().split(/\s+/);
                words.forEach(word => {
                    if (word.length > 3) {
                        const count = this.learningPatterns.get(word) || 0;
                        this.learningPatterns.set(word, count + 1);
                    }
                });
            }

            matchesPattern(message, keywords) {
                const lowerMessage = message.toLowerCase();
                return keywords.some(keyword => lowerMessage.includes(keyword));
            }

            async attemptAdvancedTaskCreation(message) {
                for (let pattern of this.advancedPatterns.taskCreation) {
                    const match = message.match(pattern);
                    if (match) {
                        const taskData = this.extractAdvancedTaskData(match, message);
                        if (taskData.activity && taskData.time) {
                            const success = this.createAdvancedTask(taskData);
                            if (success) {
                                const category = this.categorizeActivity(taskData.activity);
                                return {
                                    success: true,
                                    response: `‚úÖ **Task Created Successfully!**\n\nüìã **Activity:** ${taskData.activity}\n‚è∞ **Time:** ${taskData.time}\n‚è±Ô∏è **Duration:** ${taskData.duration} minutes\nüéØ **Category:** ${category}\n\n${this.getContextualEncouragement(category)}`
                                };
                            }
                        }
                    }
                }
                return { success: false };
            }

            extractAdvancedTaskData(match, originalMessage) {
                let activity = '';
                let time = '';
                let duration = 60;

                // Smart extraction based on match pattern
                if (match.length >= 4) {
                    activity = match[1] ? match[1].trim() : '';
                    time = match[2] ? match[2].trim() : '';
                    duration = match[3] ? this.parseDuration(match[3]) : this.predictDuration(activity);
                }

                // Enhanced activity cleaning
                activity = this.enhancedActivityCleaning(activity);
                time = this.enhancedTimeParsing(time);

                return { activity, time, duration };
            }

            enhancedActivityCleaning(activity) {
                if (!activity) return 'New Task';

                // Remove filler words and improve formatting
                activity = activity
                    .replace(/^(to\s+|for\s+|i\s+want\s+to\s+|i\s+need\s+to\s+|let\s+me\s+|help\s+me\s+|remind\s+me\s+to\s+)/i, '')
                    .replace(/\s+(at|from|starting|for|lasting)\s+.*$/i, '')
                    .replace(/^\s*(a|an|the)\s+/i, '')
                    .trim();

                // Smart capitalization
                activity = activity.charAt(0).toUpperCase() + activity.slice(1);

                // Add context if too short
                if (activity.length < 3) {
                    activity = 'New Task';
                }

                return activity;
            }

            enhancedTimeParsing(timeStr) {
                if (!timeStr) return '';

                const cleanTime = timeStr.replace(/\s+/g, '').toLowerCase();

                // Handle various time formats
                if (cleanTime.includes(':')) {
                    const parts = cleanTime.split(':');
                    if (parts.length === 2) {
                        let hour = parseInt(parts[0]);
                        let minute = parseInt(parts[1].replace(/[^\d]/g, ''));

                        if (cleanTime.includes('pm') && hour !== 12) hour += 12;
                        if (cleanTime.includes('am') && hour === 12) hour = 0;

                        return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    }
                }

                const match = cleanTime.match(/(\d{1,2})(am|pm)/);
                if (match) {
                    let hour = parseInt(match[1]);
                    const period = match[2];

                    if (period === 'pm' && hour !== 12) hour += 12;
                    if (period === 'am' && hour === 12) hour = 0;

                    return `${hour.toString().padStart(2, '0')}:00`;
                }

                return timeStr;
            }

            parseDuration(durationStr) {
                const match = durationStr.match(/(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr)/i);
                if (match) {
                    const value = parseInt(match[1]);
                    const unit = match[0].toLowerCase();
                    return unit.includes('hour') || unit.includes('hr') || unit.includes('h') ? value * 60 : value;
                }
                return 60;
            }

            predictDuration(activity) {
                const lowerActivity = activity.toLowerCase();
                
                if (this.advancedPatterns.studySession.test(lowerActivity)) return 45;
                if (this.advancedPatterns.workSession.test(lowerActivity)) return 60;
                if (this.advancedPatterns.wellness.test(lowerActivity)) return 30;
                
                return 60;
            }

            categorizeActivity(activity) {
                const lowerActivity = activity.toLowerCase();
                
                if (this.advancedPatterns.studySession.test(lowerActivity)) return 'Study & Learning';
                if (this.advancedPatterns.workSession.test(lowerActivity)) return 'Work & Professional';
                if (this.advancedPatterns.wellness.test(lowerActivity)) return 'Health & Wellness';
                
                return 'Personal & Lifestyle';
            }

            getContextualEncouragement(category) {
                const categoryMap = {
                    'Study & Learning': 'study',
                    'Work & Professional': 'work',
                    'Health & Wellness': 'wellness'
                };
                
                const responseKey = categoryMap[category] || 'general';
                const responses = this.motivationalResponses[responseKey];
                return responses[Math.floor(Math.random() * responses.length)];
            }

            createAdvancedTask(taskData) {
                const newTask = {
                    id: Date.now(),
                    title: taskData.activity,
                    time: taskData.time,
                    duration: taskData.duration,
                    completed: false,
                    createdAt: new Date(),
                    createdBy: 'AI',
                    category: this.categorizeActivity(taskData.activity),
                    hasTimer: false,
                    timerActive: false,
                    remainingTime: taskData.duration * 60,
                    notificationScheduled: true
                };

                tasks.push(newTask);
                scheduleTaskNotification(newTask);
                this.updateUI();
                showNotification(`‚úÖ Task created: ${taskData.activity} at ${taskData.time}`);

                return true;
            }

            generateAdvancedProgressReport() {
                const today = new Date().toDateString();
                const todayTasks = tasks.filter(t => t.createdAt.toDateString() === today);
                const completedToday = todayTasks.filter(t => t.completed).length;
                const totalToday = todayTasks.length;
                const completionRate = totalToday > 0 ? Math.round((completedToday / totalToday) * 100) : 0;

                // Category analysis
                const categories = {};
                todayTasks.forEach(task => {
                    const cat = task.category || 'General';
                    categories[cat] = (categories[cat] || 0) + (task.completed ? 1 : 0);
                });

                let report = `üìä **Advanced Progress Analytics**\n\n`;
                report += `üìù **Today's Overview:** ${completedToday}/${totalToday} tasks (${completionRate}%)\n`;
                report += `‚è±Ô∏è **Time Investment:** ${this.calculateTotalTime()} minutes\n`;
                report += `üî• **Productivity Streak:** ${this.calculateStreak()} days\n\n`;

                // Category breakdown
                if (Object.keys(categories).length > 0) {
                    report += `üìà **Category Performance:**\n`;
                    Object.entries(categories).forEach(([category, completed]) => {
                        report += `‚Ä¢ ${category}: ${completed} completed\n`;
                    });
                    report += `\n`;
                }

                // Intelligent insights
                report += this.generateIntelligentInsights(completionRate, categories);

                return report;
            }

            generateIntelligentInsights(completionRate, categories) {
                let insights = `üß† **AI Insights:**\n`;

                if (completionRate >= 90) {
                    insights += `üåü **Outstanding Performance!** You're operating at peak productivity today!`;
                } else if (completionRate >= 75) {
                    insights += `üéØ **Excellent Focus!** You're maintaining strong momentum!`;
                } else if (completionRate >= 50) {
                    insights += `üí™ **Solid Progress!** You're building consistent habits!`;
                } else if (completionRate >= 25) {
                    insights += `üöÄ **Building Momentum!** Every step forward counts!`;
                } else {
                    insights += `‚ú® **Fresh Opportunities!** Today is full of potential!`;
                }

                // Add personalized suggestions
                insights += `\n\nüí° **Personalized Suggestions:**\n`;
                insights += `‚Ä¢ Consider time-blocking your most important tasks\n`;
                insights += `‚Ä¢ Try the Pomodoro technique for better focus\n`;
                insights += `‚Ä¢ Schedule breaks to maintain energy levels`;

                return insights;
            }

            generatePersonalizedTip() {
                const tips = [
                    "üéØ **Smart Scheduling:** Align your most challenging tasks with your peak energy hours - usually 2-4 hours after waking up.",
                    "‚ö° **Energy Management:** Use the 90-minute ultradian rhythm - work in focused 90-minute blocks with 20-minute breaks.",
                    "üîÑ **Habit Stacking:** Link new productive habits to existing ones for automatic behavioral chains.",
                    "üì± **Digital Boundaries:** Use app blockers during focused work - your future self will thank you.",
                    "üß† **Cognitive Load:** Keep a running task list to free up mental RAM for creative thinking.",
                    "üåÖ **Morning Protocol:** Start each day by identifying your 'one thing' - the task that would make today feel successful.",
                    "üé® **Environment Design:** Create distinct spaces for different types of work to trigger the right mindset automatically.",
                    "‚è∞ **Time Awareness:** Use the Pomodoro Technique but customize your intervals based on your attention span patterns."
                ];

                return tips[Math.floor(Math.random() * tips.length)];
            }

            generateContextualMotivation() {
                const hour = new Date().getHours();
                let timeBasedMotivation;

                if (hour < 10) {
                    timeBasedMotivation = "üåÖ **Morning Energy!** You're starting strong - this momentum will carry you through the entire day!";
                } else if (hour < 14) {
                    timeBasedMotivation = "‚òÄÔ∏è **Peak Performance Time!** Your mind is sharp and your energy is high - perfect time for your most important work!";
                } else if (hour < 17) {
                    timeBasedMotivation = "üéØ **Afternoon Focus!** You're in the productivity zone - keep that momentum going strong!";
                } else {
                    timeBasedMotivation = "üåÜ **Evening Excellence!** You're finishing strong - every completed task is a victory!";
                }

                return timeBasedMotivation;
            }

            handleThemeRequest(message) {
                const themes = ['light', 'dark', 'minimal', 'elegant', 'awesome'];
                const requestedTheme = themes.find(theme => message.toLowerCase().includes(theme));
                
                if (requestedTheme) {
                    setTheme(requestedTheme);
                    return `üé® **Theme Updated!** I've switched to ${requestedTheme} mode. How does it look?`;
                }
                
                return `üé® **Theme Options:** I can switch to Light, Dark, Minimal, Elegant, or Awesome themes. Just say "switch to dark theme" or similar!`;
            }

            generateIntelligentResponse(message) {
                const responses = [
                    "I'm your advanced AI productivity coach! I can create tasks from natural language, analyze your progress with deep insights, and provide personalized motivation. What would you like to accomplish?",
                    "Ready to boost your productivity to the next level? I understand complex requests and can help you optimize your entire workflow. How can I assist you today?",
                    "I'm here to help you achieve peak performance! Try asking me to create tasks, analyze patterns in your productivity, or provide personalized coaching. What's your goal?",
                    "Your AI productivity partner is ready! I can handle natural language task creation, provide intelligent insights, and adapt to your personal style. What shall we work on?"
                ];

                return responses[Math.floor(Math.random() * responses.length)];
            }

            updateUI() {
                renderTasks();
                updateStats();
                updateProgressChart();
                updateProgressRing();
            }

            calculateTotalTime() {
                const today = new Date().toDateString();
                return completedTasks
                    .filter(t => t.completedAt && t.completedAt.toDateString() === today)
                    .reduce((total, t) => total + (t.duration || 0), 0);
            }

            calculateStreak() {
                const today = new Date().toDateString();
                const todayCompleted = completedTasks.filter(t => 
                    t.completedAt && t.completedAt.toDateString() === today
                ).length;
                return todayCompleted > 0 ? Math.min(todayCompleted, 15) : 0;
            }
        }

        const ai = new UltraAdvancedAI();

        // Theme Management
        function setTheme(themeName) {
            currentTheme = themeName;
            document.body.setAttribute('data-theme', themeName);
            
            // Update theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-theme') === themeName);
            });
            
            // Save theme preference
            localStorage.setItem('flowstate-theme', themeName);
            
            // Update chart colors if chart exists
            if (progressChart) {
                updateProgressChart();
            }
            
            showNotification(`üé® Switched to ${themeName} theme`);
        }

        // Load saved theme
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('flowstate-theme') || 'light';
            setTheme(savedTheme);
        }

        // Enhanced Timer Management
        function startActivityTimer(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            task.hasTimer = true;
            task.timerActive = true;
            
            const timerId = setInterval(() => {
                if (task.remainingTime > 0) {
                    task.remainingTime--;
                    renderTasks(); // Update display
                } else {
                    completeTaskTimer(taskId);
                }
            }, 1000);
            
            activeTimers.set(taskId, timerId);
            renderTasks();
            showNotification(`‚è±Ô∏è Timer started for ${task.title}`);
        }

        function pauseActivityTimer(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            task.timerActive = false;
            const timerId = activeTimers.get(taskId);
            if (timerId) {
                clearInterval(timerId);
                activeTimers.delete(taskId);
            }
            renderTasks();
            showNotification(`‚è∏Ô∏è Timer paused for ${task.title}`);
        }

        function completeTaskTimer(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            // Clear timer
            const timerId = activeTimers.get(taskId);
            if (timerId) {
                clearInterval(timerId);
                activeTimers.delete(taskId);
            }

            // Mark as completed
            task.completed = true;
            task.timerActive = false;
            completedTasks.push({
                ...task,
                completedAt: new Date()
            });

            // Show completion notification with snooze option
            showTaskCompletionModal(task);
            
            renderTasks();
            updateStats();
            updateProgressChart();
            updateProgressRing();
        }

        function showTaskCompletionModal(task) {
            const modal = document.getElementById('activityNotification');
            const title = document.getElementById('notificationTitle');
            const body = document.getElementById('notificationBody');
            
            title.textContent = 'üéâ Task Completed!';
            body.innerHTML = `
                <strong>${task.title}</strong><br>
                Great job! You've completed your ${task.duration}-minute session.<br><br>
                Would you like to extend your session?
            `;
            
            // Update modal actions for completion
            const actions = modal.querySelector('.notification-actions');
            actions.innerHTML = `
                <button class="btn btn-primary" onclick="extendTask(${task.id}, 15)">Extend 15min</button>
                <button class="btn btn-primary" onclick="extendTask(${task.id}, 30)">Extend 30min</button>
                <button class="btn btn-secondary" onclick="dismissActivityNotification()">Finish</button>
            `;
            
            modal.classList.add('show');
        }

        function extendTask(taskId, additionalMinutes) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            task.remainingTime = additionalMinutes * 60;
            task.duration += additionalMinutes;
            task.completed = false;
            task.timerActive = true;

            // Remove from completed tasks
            completedTasks = completedTasks.filter(t => t.id !== taskId);

            startActivityTimer(taskId);
            dismissActivityNotification();
            showNotification(`‚è±Ô∏è Extended ${task.title} by ${additionalMinutes} minutes`);
        }

        // Study Alarm System
        function setStudyAlarm() {
            const startTime = document.getElementById('studyStartTime').value;
            const duration = parseInt(document.getElementById('studyDuration').value);
            
            if (!startTime) {
                showNotification('‚ùå Please select a start time');
                return;
            }

            const now = new Date();
            const alarmTime = new Date();
            const [hours, minutes] = startTime.split(':');
            alarmTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

            // If alarm time is in the past, set for tomorrow
            if (alarmTime <= now) {
                alarmTime.setDate(alarmTime.getDate() + 1);
            }

            const timeUntilAlarm = alarmTime.getTime() - now.getTime();

            studyAlarmTimeout = setTimeout(() => {
                triggerStudyAlarm(duration);
            }, timeUntilAlarm);

            studyModeActive = true;
            document.getElementById('studyModeIndicator').classList.add('show');
            document.getElementById('stopStudyBtn').style.display = 'inline-block';
            
            const timeString = alarmTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            showNotification(`üìö Study alarm set for ${timeString} (${duration} minutes)`);
        }

        function triggerStudyAlarm(duration) {
            const modal = document.getElementById('activityNotification');
            const title = document.getElementById('notificationTitle');
            const body = document.getElementById('notificationBody');
            
            title.textContent = 'üìö Study Time!';
            body.innerHTML = `
                <strong>Time to focus!</strong><br>
                Your ${duration}-minute study session is starting now.<br>
                Create a distraction-free environment and let's begin!
            `;
            
            // Update modal actions for study session
            const actions = modal.querySelector('.notification-actions');
            actions.innerHTML = `
                <button class="btn btn-primary" onclick="startStudySession(${duration})">Start Studying</button>
                <button class="btn btn-secondary" onclick="snoozeStudyAlarm(5)">Snooze 5min</button>
                <button class="btn btn-secondary" onclick="snoozeStudyAlarm(10)">Snooze 10min</button>
                <button class="btn btn-secondary" onclick="dismissActivityNotification()">Skip</button>
            `;
            
            modal.classList.add('show');
            
            // Play study alarm sound (if browser supports)
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance('Study time! Time to focus and learn.');
                utterance.rate = 0.8;
                utterance.pitch = 1.2;
                speechSynthesis.speak(utterance);
            }
        }

        function startStudySession(duration) {
            // Create a study task automatically
            const studyTask = {
                id: Date.now(),
                title: 'Focused Study Session',
                time: new Date().toTimeString().slice(0, 5),
                duration: duration,
                completed: false,
                createdAt: new Date(),
                createdBy: 'Study Alarm',
                category: 'Study & Learning',
                hasTimer: true,
                timerActive: true,
                remainingTime: duration * 60,
                notificationScheduled: false
            };

            tasks.push(studyTask);
            startActivityTimer(studyTask.id);
            dismissActivityNotification();
            
            renderTasks();
            showNotification('üìö Study session started! Stay focused!');
        }

        function snoozeStudyAlarm(minutes) {
            studyAlarmTimeout = setTimeout(() => {
                triggerStudyAlarm(parseInt(document.getElementById('studyDuration').value));
            }, minutes * 60000);
            
            dismissActivityNotification();
            showNotification(`üò¥ Study alarm snoozed for ${minutes} minutes`);
        }

        function stopStudyAlarm() {
            if (studyAlarmTimeout) {
                clearTimeout(studyAlarmTimeout);
                studyAlarmTimeout = null;
            }
            
            studyModeActive = false;
            document.getElementById('studyModeIndicator').classList.remove('show');
            document.getElementById('stopStudyBtn').style.display = 'none';
            
            showNotification('üìö Study alarm stopped');
        }

        // Enhanced Task Rendering with Timers
        function renderTasks() {
            const container = document.getElementById('tasksList');
            const summary = document.getElementById('tasksSummary');
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div>No tasks yet. Create your first task above!</div>
                    </div>
                `;
                summary.textContent = 'No tasks scheduled';
                return;
            }
            
            const today = new Date().toDateString();
            const todayTasks = tasks.filter(t => t.createdAt.toDateString() === today);
            const completedToday = todayTasks.filter(t => t.completed).length;
            
            summary.textContent = `${completedToday}/${todayTasks.length} completed today`;
            
            container.innerHTML = '';
            
            // Sort tasks by time
            const sortedTasks = [...tasks].sort((a, b) => a.time.localeCompare(b.time));
            
            sortedTasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;
                
                // Format timer display
                const formatTime = (seconds) => {
                    const hrs = Math.floor(seconds / 3600);
                    const mins = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    if (hrs > 0) {
                        return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    }
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };

                taskElement.innerHTML = `
                    <div class="task-main">
                        <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})"></div>
                        <div class="task-info">
                            <div class="task-title">${task.title}</div>
                            <div class="task-meta">${task.time} ‚Ä¢ ${task.duration} min ‚Ä¢ ${task.createdBy || 'Manual'}</div>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-secondary btn-small" onclick="removeTask(${task.id})">Remove</button>
                        </div>
                    </div>
                    ${task.hasTimer ? `
                        <div class="activity-timer">
                            <div class="timer-display">${formatTime(task.remainingTime)}</div>
                            <div class="timer-controls">
                                ${!task.timerActive ? 
                                    `<button class="timer-btn" onclick="startActivityTimer(${task.id})">Start</button>` : 
                                    `<button class="timer-btn active" onclick="pauseActivityTimer(${task.id})">Pause</button>`
                                }
                                <button class="timer-btn" onclick="resetActivityTimer(${task.id})">Reset</button>
                                <button class="timer-btn" onclick="completeTaskTimer(${task.id})">Complete</button>
                            </div>
                        </div>
                    ` : `
                        <div class="activity-timer">
                            <button class="timer-btn" onclick="addTimerToTask(${task.id})">Add Timer</button>
                        </div>
                    `}
                `;
                container.appendChild(taskElement);
            });
        }

        function addTimerToTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            task.hasTimer = true;
            task.remainingTime = task.duration * 60;
            renderTasks();
            showNotification(`‚è±Ô∏è Timer added to ${task.title}`);
        }

        function resetActivityTimer(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            // Clear existing timer
            const timerId = activeTimers.get(taskId);
            if (timerId) {
                clearInterval(timerId);
                activeTimers.delete(taskId);
            }

            task.remainingTime = task.duration * 60;
            task.timerActive = false;
            renderTasks();
            showNotification(`üîÑ Timer reset for ${task.title}`);
        }

        // Task notification scheduling
        function scheduleTaskNotification(task) {
            if (!('Notification' in window) || Notification.permission !== 'granted') return;

            const taskTime = new Date();
            const [hours, minutes] = task.time.split(':');
            taskTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

            // If time is in the past, schedule for tomorrow
            if (taskTime <= new Date()) {
                taskTime.setDate(taskTime.getDate() + 1);
            }

            const timeUntilTask = taskTime.getTime() - Date.now();

            setTimeout(() => {
                showTaskNotification(task);
            }, timeUntilTask);
        }

        function showTaskNotification(task) {
            const modal = document.getElementById('activityNotification');
            const title = document.getElementById('notificationTitle');
            const body = document.getElementById('notificationBody');
            
            title.textContent = `‚è∞ Time for ${task.title}!`;
            body.innerHTML = `
                Your ${task.duration}-minute session is starting now.<br>
                Ready to be productive?
            `;
            
            const actions = modal.querySelector('.notification-actions');
            actions.innerHTML = `
                <button class="btn btn-primary" onclick="startActivityFromNotification(${task.id})">Start Timer</button>
                <button class="btn btn-secondary" onclick="snoozeActivity(5)">Snooze 5min</button>
                <button class="btn btn-secondary" onclick="snoozeActivity(10)">Snooze 10min</button>
                <button class="btn btn-secondary" onclick="dismissActivityNotification()">Skip</button>
            `;
            
            modal.classList.add('show');

            // Browser notification
            if (Notification.permission === 'granted') {
                new Notification(`Time for ${task.title}!`, {
                    body: `Your ${task.duration}-minute session is starting now.`,
                    icon: 'icon-192.png',
                    tag: `task-${task.id}`
                });
            }
        }

        function startActivityFromNotification(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            if (!task.hasTimer) {
                addTimerToTask(taskId);
            }
            
            startActivityTimer(taskId);
            dismissActivityNotification();
        }

        function snoozeActivity(minutes) {
            const modal = document.getElementById('activityNotification');
            const taskId = modal.dataset.taskId;
            
            setTimeout(() => {
                // Re-show the notification
                const task = tasks.find(t => t.id === parseInt(taskId));
                if (task) {
                    showTaskNotification(task);
                }
            }, minutes * 60000);
            
            dismissActivityNotification();
            showNotification(`üò¥ Task snoozed for ${minutes} minutes`);
        }

        function dismissActivityNotification() {
            document.getElementById('activityNotification').classList.remove('show');
        }

        // PWA Installation Enhanced
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show custom install prompt instead of browser's default
            setTimeout(() => {
                document.getElementById('installPrompt').classList.add('show');
            }, 5000); // Show after 5 seconds
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showNotification('üéâ App installed successfully!');
                    }
                    deferredPrompt = null;
                });
            }
            dismissInstall();
        }

        function dismissInstall() {
            document.getElementById('installPrompt').classList.remove('show');
        }

        // Core Functions (Enhanced versions of previous functions)
        function toggleCreationMode() {
            isAIMode = !isAIMode;
            const modeText = document.getElementById('modeText');
            const manualMode = document.getElementById('manualMode');
            const aiMode = document.getElementById('aiMode');
            
            if (isAIMode) {
                modeText.textContent = 'AI Assistant';
                manualMode.style.display = 'none';
                aiMode.style.display = 'block';
            } else {
                modeText.textContent = 'Manual';
                manualMode.style.display = 'block';
                aiMode.style.display = 'none';
            }
        }

        function createTaskManual() {
            const title = document.getElementById('taskTitle').value.trim();
            const time = document.getElementById('taskTime').value;
            const duration = parseInt(document.getElementById('taskDuration').value);
            
            if (!title || !time) {
                showNotification('‚ùå Please fill in all fields');
                return;
            }
            
            const newTask = {
                id: Date.now(),
                title: title,
                time: time,
                duration: duration,
                completed: false,
                createdAt: new Date(),
                createdBy: 'Manual',
                category: ai.categorizeActivity(title),
                hasTimer: false,
                timerActive: false,
                remainingTime: duration * 60,
                notificationScheduled: true
            };
            
            tasks.push(newTask);
            scheduleTaskNotification(newTask);
            
            // Clear inputs
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskTime').value = '';
            
            renderTasks();
            updateStats();
            updateProgressChart();
            updateProgressRing();
            showNotification('‚úÖ Task created successfully!');
        }

        async function createTaskAI() {
            const input = document.getElementById('aiTaskInput');
            const message = input.value.trim();
            
            if (!message) {
                showNotification('‚ùå Please enter a task description');
                return;
            }
            
            // Add user message to chat
            addChatMessage(message, 'user');
            
            // Clear input immediately
            input.value = '';
            
            try {
                // Process with advanced AI
                const response = await ai.processMessage(message);
                addChatMessage(response, 'ai');
                
            } catch (error) {
                console.error('AI processing error:', error);
                addChatMessage('I apologize, but I encountered an error processing your request. Please try again.', 'ai');
            }
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                
                if (task.completed) {
                    // Clear any active timer
                    const timerId = activeTimers.get(id);
                    if (timerId) {
                        clearInterval(timerId);
                        activeTimers.delete(id);
                    }
                    
                    completedTasks.push({
                        ...task,
                        completedAt: new Date()
                    });
                    showNotification('üéâ Task completed!');
                    addChatMessage('üéâ Excellent work! Task completed successfully!', 'system');
                } else {
                    completedTasks = completedTasks.filter(t => t.id !== id);
                }
                
                renderTasks();
                updateStats();
                updateProgressChart();
                updateProgressRing();
            }
        }

        function removeTask(id) {
            // Clear any active timer
            const timerId = activeTimers.get(id);
            if (timerId) {
                clearInterval(timerId);
                activeTimers.delete(id);
            }
            
            tasks = tasks.filter(t => t.id !== id);
            completedTasks = completedTasks.filter(t => t.id !== id);
            renderTasks();
            updateStats();
            updateProgressChart();
            updateProgressRing();
            showNotification('üóëÔ∏è Task removed');
        }

        function updateStats() {
            const today = new Date().toDateString();
            const todayTasks = tasks.filter(t => t.createdAt.toDateString() === today);
            const completedToday = todayTasks.filter(t => t.completed).length;
            const totalToday = todayTasks.length;
            const completionRate = totalToday > 0 ? Math.round((completedToday / totalToday) * 100) : 0;
            const totalTime = Math.round(ai.calculateTotalTime() / 60 * 10) / 10;
            const streak = ai.calculateStreak();
            
            document.getElementById('completionRate').textContent = `${completionRate}%`;
            document.getElementById('totalTime').textContent = `${totalTime}h`;
            document.getElementById('streakCount').textContent = streak;
            document.getElementById('totalTasks').textContent = totalToday;
        }

        function updateProgressChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            if (progressChart) {
                progressChart.destroy();
            }
            
            const data = [];
            const labels = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                
                const dayTasks = tasks.filter(t => 
                    t.createdAt.toDateString() === date.toDateString() && t.completed
                ).length;
                data.push(dayTasks);
            }
            
            // Get current theme colors
            const style = getComputedStyle(document.documentElement);
            const primaryColor = style.getPropertyValue('--primary-color').trim();
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Completed Tasks',
                        data: data,
                        borderColor: primaryColor,
                        backgroundColor: primaryColor + '20',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: primaryColor,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: style.getPropertyValue('--border-color').trim()
                            },
                            ticks: {
                                color: style.getPropertyValue('--text-secondary').trim()
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: style.getPropertyValue('--text-secondary').trim()
                            }
                        }
                    }
                }
            });
        }

        function updateProgressRing() {
            const today = new Date().toDateString();
            const todayTasks = tasks.filter(t => t.createdAt.toDateString() === today);
            const completedToday = todayTasks.filter(t => t.completed).length;
            const totalToday = todayTasks.length;
            const percentage = totalToday > 0 ? (completedToday / totalToday) * 100 : 0;
            
            const circle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 40;
            const offset = circumference - (percentage / 100) * circumference;
            
            circle.style.strokeDashoffset = offset;
            document.getElementById('progressPercent').textContent = `${Math.round(percentage)}%`;
            
            const messageElement = document.getElementById('dailyMessage');
            if (percentage >= 100) {
                messageElement.textContent = "Perfect day! üéâ";
            } else if (percentage >= 80) {
                messageElement.textContent = "Almost there! üåü";
            } else if (percentage >= 50) {
                messageElement.textContent = "Great progress! üí™";
            } else if (percentage > 0) {
                messageElement.textContent = "Keep going! üöÄ";
            } else {
                messageElement.textContent = "Ready to start! ‚ú®";
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage(message, 'user');
            
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.classList.add('show');
            
            try {
                const response = await ai.processMessage(message);
                typingIndicator.classList.remove('show');
                addChatMessage(response, 'ai');
            } catch (error) {
                console.error('Chat error:', error);
                typingIndicator.classList.remove('show');
                addChatMessage('I apologize, but I encountered an error. Please try again.', 'ai');
            }
            
            input.value = '';
        }

        function addChatMessage(message, sender) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            
            if (sender === 'ai') {
                div.innerHTML = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            } else {
                div.textContent = message;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function quickAction(action) {
            const actions = {
                'progress': 'Show my detailed progress analysis',
                'tips': 'Give me a personalized productivity tip',
                'motivation': 'I need some motivation and encouragement'
            };
            
            const input = document.getElementById('chatInput');
            input.value = actions[action];
            sendMessage();
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification('üîî Notifications enabled for task reminders');
                    }
                });
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedTheme();
            renderTasks();
            updateStats();
            updateProgressChart();
            updateProgressRing();
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(requestNotificationPermission, 2000);
            }
            
            // Add welcome message
            setTimeout(() => {
                addChatMessage("üëã Welcome to FlowState Pro! I'm your ultra-advanced AI productivity companion with natural language understanding, individual task timers, study alarms, and multiple beautiful themes. Try asking me to 'create a study session at 8 PM for 45 minutes' or explore the different themes above!", 'ai');
            }, 1500);
            
            // Enable Enter key for all inputs
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            
            document.getElementById('aiTaskInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') createTaskAI();
            });
            
            // Show install prompt for non-installed users
            if (!window.matchMedia('(display-mode: standalone)').matches) {
                setTimeout(() => {
                    if (deferredPrompt) {
                        document.getElementById('installPrompt').classList.add('show');
                    }
                }, 10000);
            }
        });
    </script>
</body>
</html>
