<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowState Pro - AI Productivity Assistant</title>
    <meta name="description" content="Apple-inspired AI productivity app with intelligent task management">
    <meta name="theme-color" content="#007AFF">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Apple-inspired Design System */
        :root {
            --primary-blue: #007AFF;
            --primary-blue-dark: #0056CC;
            --secondary-blue: #5AC8FA;
            --success-green: #34C759;
            --warning-orange: #FF9500;
            --danger-red: #FF3B30;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --text-tertiary: #C7C7CC;
            --background-primary: #F2F2F7;
            --background-secondary: #FFFFFF;
            --background-tertiary: #F2F2F7;
            --separator: #C6C6C8;
            --overlay: rgba(0, 0, 0, 0.4);
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --card-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
            --border-radius: 10px;
            --border-radius-large: 20px;
        }

        [data-theme="dark"] {
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --text-tertiary: #48484A;
            --background-primary: #000000;
            --background-secondary: #1C1C1E;
            --background-tertiary: #2C2C2E;
            --separator: #38383A;
            --overlay: rgba(0, 0, 0, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            background: var(--background-primary);
            color: var(--text-primary);
            line-height: 1.47;
            font-size: 17px;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* Simple Authentication */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-card {
            background: var(--background-secondary);
            border-radius: var(--border-radius-large);
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .auth-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            border-radius: 20px;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            color: white;
        }

        .auth-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .auth-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .auth-input {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--separator);
            border-radius: var(--border-radius);
            background: var(--background-tertiary);
            color: var(--text-primary);
            font-size: 17px;
            margin-bottom: 16px;
            transition: all 0.2s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: var(--background-secondary);
        }

        .auth-button {
            width: 100%;
            padding: 16px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auth-button:hover {
            background: var(--primary-blue-dark);
        }

        /* Main App Layout */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding: 16px 0;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }

        .app-name {
            font-size: 34px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .theme-toggle {
            background: var(--background-secondary);
            border: 1px solid var(--separator);
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--background-tertiary);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--background-secondary);
            border: 1px solid var(--separator);
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .user-menu:hover {
            background: var(--background-tertiary);
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            background: var(--primary-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        /* Apple-style Cards */
        .card {
            background: var(--background-secondary);
            border-radius: var(--border-radius-large);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--separator);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-2px);
        }

        .card-header {
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .card-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }

        /* AI Assistant Section */
        .ai-section {
            background: var(--background-secondary);
            border-radius: var(--border-radius-large);
            padding: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--separator);
            margin-bottom: 20px;
        }

        .ai-mode-toggle {
            display: flex;
            background: var(--background-tertiary);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .ai-mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-mode-btn.active {
            background: var(--background-secondary);
            color: var(--primary-blue);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--separator);
            border-radius: var(--border-radius);
            background: var(--background-tertiary);
            color: var(--text-primary);
            font-size: 17px;
            transition: all 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: var(--background-secondary);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-blue-dark);
        }

        .btn-secondary {
            background: var(--background-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--separator);
        }

        .btn-secondary:hover {
            background: var(--background-primary);
        }

        /* Task List - Apple Reminders Style */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--background-secondary);
            border-radius: var(--border-radius);
            border: 1px solid var(--separator);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .task-item:hover {
            background: var(--background-tertiary);
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-blue);
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-checkbox.checked {
            background: var(--primary-blue);
            color: white;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .task-meta {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            gap: 12px;
        }

        .task-controls {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .task-item:hover .task-controls {
            opacity: 1;
        }

        .task-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid var(--separator);
            background: var(--background-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-btn:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        /* Apple-style Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--background-secondary);
            border: 1px solid var(--separator);
            border-radius: var(--border-radius-large);
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 350px;
            backdrop-filter: blur(20px);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .notification-icon {
            font-size: 24px;
        }

        .notification-title {
            font-weight: 700;
            color: var(--text-primary);
        }

        .notification-body {
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .notification-actions {
            display: flex;
            gap: 8px;
        }

        /* Progress Ring - Apple Watch Style */
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 20px auto;
            position: relative;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }

        .progress-ring .background {
            stroke: var(--separator);
        }

        .progress-ring .progress {
            stroke: var(--primary-blue);
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s ease;
        }

        .progress-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percent {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .progress-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--background-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--separator);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* AI Chat Interface */
        .ai-chat {
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--background-tertiary);
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            border: 1px solid var(--separator);
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: var(--primary-blue);
            color: white;
            margin-left: auto;
        }

        .message.ai {
            background: var(--background-secondary);
            color: var(--text-primary);
            border: 1px solid var(--separator);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .app-container {
                padding: 16px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--separator);
            border-radius: 50%;
            border-top-color: var(--primary-blue);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hide/Show Elements */
        .hidden { display: none !important; }
        .show { display: block !important; }
    </style>
</head>
<body data-theme="light">
    <!-- Simple Authentication -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-card">
            <div class="auth-logo">FS</div>
            <h1 class="auth-title">Welcome to FlowState Pro</h1>
            <p class="auth-subtitle">Your AI-powered productivity companion</p>
            <input type="text" class="auth-input" id="nameInput" placeholder="Your Name" required>
            <button class="auth-button" onclick="quickSignIn()">Get Started</button>
        </div>
    </div>

    <div class="app-container">
        <!-- App Header -->
        <header class="app-header">
            <div class="app-title">
                <div class="app-icon">FS</div>
                <h1 class="app-name">FlowState Pro</h1>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">üåô</span>
                </button>
                <div class="user-menu" onclick="showUserMenu()">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">Anonymous</span>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="main-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- AI Task Creator -->
                <div class="ai-section">
                    <div class="card-header">
                        <h2 class="card-title">ü§ñ AI Task Assistant</h2>
                        <p class="card-subtitle">Create tasks naturally with AI or manually</p>
                    </div>

                    <div class="ai-mode-toggle">
                        <button class="ai-mode-btn active" id="aiModeBtn" onclick="setMode('ai')">AI Assistant</button>
                        <button class="ai-mode-btn" id="manualModeBtn" onclick="setMode('manual')">Manual Entry</button>
                    </div>

                    <!-- AI Mode -->
                    <div id="aiMode">
                        <div class="input-group">
                            <input type="text" class="input-field" id="aiInput" placeholder="Tell me what you want to do... (e.g., 'Study math for 2 hours at 7 PM')">
                            <button class="btn btn-primary" onclick="createWithAI()">
                                <span>üß†</span> Create
                            </button>
                        </div>
                    </div>

                    <!-- Manual Mode -->
                    <div id="manualMode" class="hidden">
                        <div class="input-group">
                            <input type="text" class="input-field" id="taskTitle" placeholder="Task title">
                            <input type="time" class="input-field" id="taskTime" style="flex: 0 0 120px;">
                            <select class="input-field" id="taskDuration" style="flex: 0 0 100px;">
                                <option value="15">15m</option>
                                <option value="30">30m</option>
                                <option value="45">45m</option>
                                <option value="60">1h</option>
                                <option value="90">1.5h</option>
                                <option value="120">2h</option>
                            </select>
                            <button class="btn btn-primary" onclick="createManually()">
                                <span>‚ûï</span> Add
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Today's Tasks -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìã Today's Tasks</h2>
                        <p class="card-subtitle" id="taskSummary">No tasks yet</p>
                    </div>
                    <div class="task-list" id="taskList">
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
                            <p>Create your first task above!</p>
                        </div>
                    </div>
                </div>

                <!-- AI Chat Assistant -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üí¨ AI Assistant</h2>
                        <p class="card-subtitle">Get help, motivation, and guidance</p>
                    </div>
                    <div class="ai-chat">
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="input-group">
                            <input type="text" class="input-field" id="chatInput" placeholder="Ask me anything...">
                            <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Daily Progress -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìä Daily Progress</h2>
                        <p class="card-subtitle">Your productivity overview</p>
                    </div>
                    
                    <div class="progress-ring">
                        <svg>
                            <circle class="background" cx="60" cy="60" r="45"></circle>
                            <circle class="progress" cx="60" cy="60" r="45" id="progressCircle"></circle>
                        </svg>
                        <div class="progress-center">
                            <div class="progress-percent" id="progressPercent">0%</div>
                            <div class="progress-label">Complete</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 16px;">
                        <div style="font-weight: 600; color: var(--text-primary);" id="progressMessage">Ready to be productive!</div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìà Statistics</h2>
                        <p class="card-subtitle">Your productivity metrics</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="todayTasks">0</div>
                            <div class="stat-label">Today's Tasks</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completedTasks">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTime">0h</div>
                            <div class="stat-label">Time Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="streakDays">0</div>
                            <div class="stat-label">Streak</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">‚ö° Quick Actions</h2>
                        <p class="card-subtitle">Common productivity tools</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <button class="btn btn-secondary" onclick="startPomodoro()">
                            üçÖ Pomodoro
                        </button>
                        <button class="btn btn-secondary" onclick="setBreakReminder()">
                            ‚òï Break
                        </button>
                        <button class="btn btn-secondary" onclick="showMotivation()">
                            üí™ Motivate
                        </button>
                        <button class="btn btn-secondary" onclick="exportData()">
                            üì§ Export
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Template -->
    <div class="notification" id="notification">
        <div class="notification-header">
            <span class="notification-icon" id="notificationIcon">‚è∞</span>
            <span class="notification-title" id="notificationTitle">Task Reminder</span>
        </div>
        <div class="notification-body" id="notificationBody">
            It's time for your scheduled task!
        </div>
        <div class="notification-actions">
            <button class="btn btn-primary" onclick="startTask()" style="flex: 1;">Start</button>
            <button class="btn btn-secondary" onclick="snoozeTask()" style="flex: 1;">Snooze</button>
            <button class="btn btn-secondary" onclick="dismissNotification()">√ó</button>
        </div>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let tasks = [];
        let completedTasks = [];
        let currentMode = 'ai';
        let currentTheme = 'light';
        let activeTimers = new Map();
        let currentNotificationTask = null;

        // Advanced AI Assistant
        class AppleStyleAI {
            constructor() {
                this.context = [];
                this.patterns = {
                    taskCreation: [
                        /(?:create|add|schedule|make|plan|set|do|work on|study|practice|exercise|read|write|call|meet)\s+([^,]+?)(?:\s+(?:at|from|starting)\s+(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m))?\s*(?:for\s+(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr))?/i,
                        /(?:remind me to|i need to|i want to|help me)\s+([^,]+?)(?:\s+(?:at|around)\s+(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m))?\s*(?:for\s+(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr))?/i,
                        /([^,]+?)\s+(?:at|from)\s+(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m)\s*(?:for\s+(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr))?/i
                    ]
                };
            }

            async processMessage(message) {
                console.log('AI processing:', message);
                
                // Try to create a task
                for (let pattern of this.patterns.taskCreation) {
                    const match = message.match(pattern);
                    if (match) {
                        const taskData = this.extractTaskData(match, message);
                        if (taskData.title) {
                            const success = this.createTask(taskData);
                            if (success) {
                                return `‚úÖ **Task Created!**\n\nüìã **${taskData.title}**\n‚è∞ ${taskData.time}\n‚è±Ô∏è ${taskData.duration} minutes\n\nI'll remind you when it's time to start! üöÄ`;
                            }
                        }
                    }
                }

                // Handle other requests
                if (message.toLowerCase().includes('progress') || message.toLowerCase().includes('stats')) {
                    return this.generateProgressReport();
                }

                if (message.toLowerCase().includes('motivat') || message.toLowerCase().includes('inspire')) {
                    return this.generateMotivation();
                }

                if (message.toLowerCase().includes('help') || message.toLowerCase().includes('how')) {
                    return this.generateHelp();
                }

                return this.generateResponse(message);
            }

            extractTaskData(match, originalMessage) {
                let title = match[1] ? match[1].trim() : '';
                let time = match[2] ? this.parseTime(match[2]) : this.getDefaultTime();
                let duration = match[3] ? this.parseDuration(match[3]) : 60;

                // Clean up title
                title = title
                    .replace(/^(to\s+|for\s+|a\s+|an\s+|the\s+)/i, '')
                    .replace(/\s+(at|from|for|lasting)\s+.*$/i, '')
                    .trim();

                if (title.length < 2) {
                    title = 'New Task';
                }

                title = title.charAt(0).toUpperCase() + title.slice(1);

                return { title, time, duration };
            }

            parseTime(timeStr) {
                const cleanTime = timeStr.replace(/\s+/g, '').toLowerCase();
                
                if (cleanTime.includes(':')) {
                    const parts = cleanTime.split(':');
                    if (parts.length === 2) {
                        let hour = parseInt(parts[0]);
                        let minute = parseInt(parts[1].replace(/[^\d]/g, ''));
                        
                        if (cleanTime.includes('pm') && hour !== 12) hour += 12;
                        if (cleanTime.includes('am') && hour === 12) hour = 0;
                        
                        return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    }
                }

                const match = cleanTime.match(/(\d{1,2})(am|pm)/);
                if (match) {
                    let hour = parseInt(match[1]);
                    const period = match[2];
                    
                    if (period === 'pm' && hour !== 12) hour += 12;
                    if (period === 'am' && hour === 12) hour = 0;
                    
                    return `${hour.toString().padStart(2, '0')}:00`;
                }

                return timeStr;
            }

            parseDuration(durationStr) {
                const match = durationStr.match(/(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr)/i);
                if (match) {
                    const value = parseInt(match[1]);
                    const unit = match[0].toLowerCase();
                    return unit.includes('hour') || unit.includes('hr') || unit.includes('h') ? value * 60 : value;
                }
                return 60;
            }

            getDefaultTime() {
                const now = new Date();
                const nextHour = now.getHours() + 1;
                return `${nextHour.toString().padStart(2, '0')}:00`;
            }

            createTask(taskData) {
                const newTask = {
                    id: Date.now(),
                    title: taskData.title,
                    time: taskData.time,
                    duration: taskData.duration,
                    completed: false,
                    createdAt: new Date(),
                    createdBy: 'AI',
                    hasAlarm: true
                };

                tasks.push(newTask);
                this.scheduleAlarm(newTask);
                updateUI();
                saveUserData();
                return true;
            }

            scheduleAlarm(task) {
                const taskTime = new Date();
                const [hours, minutes] = task.time.split(':');
                taskTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

                if (taskTime <= new Date()) {
                    taskTime.setDate(taskTime.getDate() + 1);
                }

                const timeUntilTask = taskTime.getTime() - Date.now();
                
                setTimeout(() => {
                    showTaskNotification(task);
                }, timeUntilTask);
            }

            generateProgressReport() {
                const today = new Date().toDateString();
                const todayTasks = tasks.filter(t => t.createdAt.toDateString() === today);
                const completed = todayTasks.filter(t => t.completed).length;
                const total = todayTasks.length;
                const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

                return `üìä **Your Progress Today**\n\n‚úÖ Completed: ${completed}/${total} tasks\nüìà Success Rate: ${rate}%\n‚è±Ô∏è Time Invested: ${this.calculateTimeSpent()} minutes\n\n${this.getProgressMessage(rate)}`;
            }

            generateMotivation() {
                const motivations = [
                    "üåü You're doing amazing! Every task completed is a step toward your goals!",
                    "üí™ Your consistency is building unstoppable momentum. Keep going!",
                    "üöÄ You're not just checking off tasks, you're building the life you want!",
                    "‚≠ê Your dedication today is creating tomorrow's success story!",
                    "üî• You're in the flow state - this is where magic happens!"
                ];
                return motivations[Math.floor(Math.random() * motivations.length)];
            }

            generateHelp() {
                return `ü§ñ **I'm here to help!** Here's what I can do:\n\nüìù **Create Tasks**: Just tell me what you want to do\n‚è∞ **Set Reminders**: I'll notify you when it's time\nüìä **Track Progress**: Ask me for updates anytime\nüí™ **Motivate You**: I'll keep you inspired\n\nTry saying: "Study math for 2 hours at 7 PM" or "Remind me to exercise"`;
            }

            generateResponse(message) {
                const responses = [
                    "I'm your AI productivity assistant! I can help you create tasks, set reminders, and stay motivated. What would you like to work on?",
                    "Ready to boost your productivity? I can understand natural language and help you organize your day. What's your goal?",
                    "I'm here to help you stay focused and achieve your goals! Try describing a task you want to do, and I'll set it up for you.",
                    "Let's make today productive! I can help with task creation, time management, and motivation. How can I assist you?"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }

            calculateTimeSpent() {
                const today = new Date().toDateString();
                return completedTasks
                    .filter(t => t.completedAt && t.completedAt.toDateString() === today)
                    .reduce((total, t) => total + (t.duration || 0), 0);
            }

            getProgressMessage(rate) {
                if (rate >= 80) return "üèÜ Outstanding performance! You're crushing your goals!";
                if (rate >= 60) return "üéØ Great work! You're making solid progress!";
                if (rate >= 40) return "üí™ Good momentum! Keep building those habits!";
                return "üå± Every journey starts with a single step. You've got this!";
            }
        }

        const aiAssistant = new AppleStyleAI();

        // Authentication Functions
        function quickSignIn() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                showToast('Please enter your name');
                return;
            }

            currentUser = {
                id: Date.now(),
                name: name,
                createdAt: new Date()
            };

            document.getElementById('userName').textContent = name;
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            document.getElementById('authOverlay').classList.add('hidden');
            
            loadUserData();
            showToast(`Welcome, ${name}! üëã`);
            
            // Add welcome message to chat
            setTimeout(() => {
                addChatMessage("üëã Welcome to FlowState Pro! I'm your AI assistant. I can help you create tasks, set reminders, and stay motivated. Try saying 'Study math for 2 hours at 7 PM' or ask me for help!", 'ai');
            }, 1000);
        }

        // Mode Switching
        function setMode(mode) {
            currentMode = mode;
            
            document.getElementById('aiModeBtn').classList.toggle('active', mode === 'ai');
            document.getElementById('manualModeBtn').classList.toggle('active', mode === 'manual');
            
            document.getElementById('aiMode').classList.toggle('hidden', mode !== 'ai');
            document.getElementById('manualMode').classList.toggle('hidden', mode !== 'manual');
        }

        // Task Creation Functions
        async function createWithAI() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            
            if (!message) {
                showToast('Please describe what you want to do');
                return;
            }

            // Show loading
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="loading"></span> Creating...';
            button.disabled = true;

            try {
                const response = await aiAssistant.processMessage(message);
                addChatMessage(message, 'user');
                addChatMessage(response, 'ai');
                input.value = '';
            } catch (error) {
                console.error('AI Error:', error);
                showToast('‚ùå Something went wrong. Please try again.');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function createManually() {
            const title = document.getElementById('taskTitle').value.trim();
            const time = document.getElementById('taskTime').value;
            const duration = parseInt(document.getElementById('taskDuration').value);

            if (!title) {
                showToast('Please enter a task title');
                return;
            }

            if (!time) {
                showToast('Please select a time');
                return;
            }

            const newTask = {
                id: Date.now(),
                title: title,
                time: time,
                duration: duration,
                completed: false,
                createdAt: new Date(),
                createdBy: 'Manual',
                hasAlarm: true
            };

            tasks.push(newTask);
            aiAssistant.scheduleAlarm(newTask);
            
            // Clear inputs
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskTime').value = '';
            
            updateUI();
            saveUserData();
            showToast('‚úÖ Task created successfully!');
        }

        // Task Management
        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                
                if (task.completed) {
                    completedTasks.push({
                        ...task,
                        completedAt: new Date()
                    });
                    showToast('üéâ Task completed!');
                } else {
                    completedTasks = completedTasks.filter(t => t.id !== id);
                }
                
                updateUI();
                saveUserData();
            }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            completedTasks = completedTasks.filter(t => t.id !== id);
            updateUI();
            saveUserData();
            showToast('üóëÔ∏è Task deleted');
        }

        function snoozeTaskById(id, minutes = 10) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                // Update task time
                const newTime = new Date();
                newTime.setMinutes(newTime.getMinutes() + minutes);
                task.time = `${newTime.getHours().toString().padStart(2, '0')}:${newTime.getMinutes().toString().padStart(2, '0')}`;
                
                // Reschedule alarm
                aiAssistant.scheduleAlarm(task);
                updateUI();
                saveUserData();
                showToast(`üò¥ Task snoozed for ${minutes} minutes`);
            }
        }

        // UI Update Functions
        function updateUI() {
            renderTasks();
            updateStats();
            updateProgress();
        }

        function renderTasks() {
            const container = document.getElementById('taskList');
            const summary = document.getElementById('taskSummary');
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
                        <p>Create your first task above!</p>
                    </div>
                `;
                summary.textContent = 'No tasks yet';
                return;
            }

            const today = new Date().toDateString();
            const todayTasks = tasks.filter(t => t.createdAt.toDateString() === today);
            const completed = todayTasks.filter(t => t.completed).length;
            
            summary.textContent = `${completed}/${todayTasks.length} completed today`;
            
            const sortedTasks = [...tasks].sort((a, b) => a.time.localeCompare(b.time));
            
            container.innerHTML = sortedTasks.map(task => `
                <div class="task-item ${task.completed ? 'completed' : ''}">
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})">
                        ${task.completed ? '‚úì' : ''}
                    </div>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            <span>‚è∞ ${task.time}</span>
                            <span>‚è±Ô∏è ${task.duration}m</span>
                            <span>ü§ñ ${task.createdBy}</span>
                        </div>
                    </div>
                    <div class="task-controls">
                        <button class="task-btn" onclick="snoozeTaskById(${task.id}, 10)">Snooze</button>
                        <button class="task-btn" onclick="deleteTask(${task.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            const today = new Date().toDateString();
            const todayTasks = tasks.filter(t => t.createdAt.toDateString() === today);
            const completed = todayTasks.filter(t => t.completed).length;
            const totalTime = Math.round(aiAssistant.calculateTimeSpent() / 60 * 10) / 10;
            
            document.getElementById('todayTasks').textContent = todayTasks.length;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('totalTime').textContent = `${totalTime}h`;
            document.getElementById('streakDays').textContent = calculateStreak();
        }

        function updateProgress() {
            const today = new Date().toDateString();
            const todayTasks = tasks.filter(t => t.createdAt.toDateString() === today);
            const completed = todayTasks.filter(t => t.completed).length;
            const total = todayTasks.length;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            const circle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (percentage / 100) * circumference;
            
            circle.style.strokeDashoffset = offset;
            document.getElementById('progressPercent').textContent = `${Math.round(percentage)}%`;
            
            const messages = {
                100: "Perfect day! üéâ",
                80: "Almost there! üåü",
                50: "Great progress! üí™",
                25: "Keep going! üöÄ",
                0: "Ready to be productive! ‚ú®"
            };
            
            const messageKey = Object.keys(messages).reverse().find(key => percentage >= key);
            document.getElementById('progressMessage').textContent = messages[messageKey];
        }

        function calculateStreak() {
            // Simple streak calculation
            const today = new Date().toDateString();
            const todayCompleted = completedTasks.filter(t => 
                t.completedAt && t.completedAt.toDateString() === today
            ).length;
            return todayCompleted > 0 ? Math.min(todayCompleted, 7) : 0;
        }

        // Chat Functions
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage(message, 'user');
            input.value = '';
            
            try {
                const response = await aiAssistant.processMessage(message);
                addChatMessage(response, 'ai');
            } catch (error) {
                addChatMessage('Sorry, I encountered an error. Please try again.', 'ai');
            }
        }

        function addChatMessage(message, sender) {
            const container = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'ai') {
                messageDiv.innerHTML = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            } else {
                messageDiv.textContent = message;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Notification Functions
        function showTaskNotification(task) {
            currentNotificationTask = task;
            
            document.getElementById('notificationIcon').textContent = '‚è∞';
            document.getElementById('notificationTitle').textContent = `Time for ${task.title}!`;
            document.getElementById('notificationBody').textContent = `Your ${task.duration}-minute session is starting now.`;
            
            const notification = document.getElementById('notification');
            notification.classList.add('show');
            
            // Browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`Time for ${task.title}!`, {
                    body: `Your ${task.duration}-minute session is starting now.`,
                    icon: 'icon-192.png',
                    badge: 'icon-192.png',
                    tag: `task-${task.id}`
                });
            }
            
            // Auto-dismiss after 30 seconds
            setTimeout(() => {
                dismissNotification();
            }, 30000);
        }

        function startTask() {
            if (currentNotificationTask) {
                showToast(`Started: ${currentNotificationTask.title}`);
                dismissNotification();
            }
        }

        function snoozeTask() {
            if (currentNotificationTask) {
                snoozeTaskById(currentNotificationTask.id, 10);
                dismissNotification();
            }
        }

        function dismissNotification() {
            document.getElementById('notification').classList.remove('show');
            currentNotificationTask = null;
        }

        // Utility Functions
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', currentTheme);
            document.getElementById('themeIcon').textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            saveUserData();
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--background-secondary);
                color: var(--text-primary);
                padding: 12px 24px;
                border-radius: 20px;
                border: 1px solid var(--separator);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                font-weight: 500;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function saveUserData() {
            if (currentUser) {
                const userData = {
                    user: currentUser,
                    tasks: tasks,
                    completedTasks: completedTasks,
                    theme: currentTheme
                };
                localStorage.setItem('flowstate-data', JSON.stringify(userData));
            }
        }

        function loadUserData() {
            const saved = localStorage.getItem('flowstate-data');
            if (saved) {
                const data = JSON.parse(saved);
                tasks = data.tasks || [];
                completedTasks = data.completedTasks || [];
                currentTheme = data.theme || 'light';
                
                document.body.setAttribute('data-theme', currentTheme);
                document.getElementById('themeIcon').textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            }
            
            updateUI();
        }

        // Quick Actions
        function startPomodoro() {
            const message = "Start a 25-minute Pomodoro session";
            document.getElementById('aiInput').value = message;
            createWithAI();
        }

        function setBreakReminder() {
            const message = "Remind me to take a break in 1 hour";
            document.getElementById('aiInput').value = message;
            createWithAI();
        }

        function showMotivation() {
            addChatMessage("Give me some motivation", 'user');
            setTimeout(() => {
                aiAssistant.processMessage("motivation").then(response => {
                    addChatMessage(response, 'ai');
                });
            }, 500);
        }

        function exportData() {
            const data = {
                user: currentUser,
                tasks: tasks,
                completedTasks: completedTasks,
                exportDate: new Date()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'flowstate-data.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('üì§ Data exported successfully!');
        }

        function showUserMenu() {
            showToast('üë§ User menu coming soon!');
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Check if user is already signed in
            const saved = localStorage.getItem('flowstate-data');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.user) {
                    currentUser = data.user;
                    document.getElementById('userName').textContent = data.user.name;
                    document.getElementById('userAvatar').textContent = data.user.name.charAt(0).toUpperCase();
                    document.getElementById('authOverlay').classList.add('hidden');
                    loadUserData();
                }
            }
            
            // Enable Enter key for inputs
            document.getElementById('aiInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') createWithAI();
            });
            
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            document.getElementById('nameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') quickSignIn();
            });
        });
    </script>
</body>
</html>
