<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowState Pro - AI Productivity Companion</title>
    <meta name="description" content="Advanced AI-powered productivity companion with smart task management and notifications">
    <meta name="theme-color" content="#007AFF">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed');
                    });
            });
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1d1d1f;
            line-height: 1.47059;
            font-weight: 400;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #007AFF, #5856D6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .app-name {
            font-size: 28px;
            font-weight: 700;
            color: #1d1d1f;
            letter-spacing: -0.003em;
        }

        .app-subtitle {
            font-size: 15px;
            color: #6e6e73;
            margin-left: 4px;
            font-weight: 400;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(52, 199, 89, 0.1);
            border-radius: 20px;
            color: #30d158;
            font-weight: 500;
            font-size: 14px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: #30d158;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 40px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: 14px;
            color: #6e6e73;
            font-weight: 400;
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .input-field:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background: rgba(255, 255, 255, 0.95);
        }

        .input-field::placeholder {
            color: #6e6e73;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(0, 0, 0, 0.05);
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .creation-mode {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .mode-label {
            font-weight: 500;
            color: #1d1d1f;
            font-size: 15px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e5e7;
            transition: 0.3s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background-color: #007AFF;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .ai-chat-container {
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: #007AFF;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: white;
            color: #1d1d1f;
            border: 1px solid rgba(0, 0, 0, 0.08);
            margin-right: auto;
        }

        .message.system {
            background: rgba(52, 199, 89, 0.1);
            color: #30d158;
            text-align: center;
            margin: 8px auto;
            font-size: 14px;
            font-weight: 500;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: rgba(248, 249, 250, 0.6);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .task-item:hover {
            background: rgba(248, 249, 250, 0.8);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .task-item.completed {
            background: rgba(52, 199, 89, 0.1);
            border-color: rgba(52, 199, 89, 0.2);
        }

        .task-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #007AFF;
            border-radius: 50%;
            margin-right: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .task-checkbox:hover {
            transform: scale(1.1);
        }

        .task-checkbox.checked {
            background: #007AFF;
            border-color: #007AFF;
        }

        .task-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 4px;
            font-size: 16px;
        }

        .task-meta {
            font-size: 14px;
            color: #6e6e73;
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #007AFF;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: #6e6e73;
            font-weight: 500;
        }

        .progress-ring {
            width: 100px;
            height: 100px;
            margin: 20px auto;
            position: relative;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
        }

        .progress-ring .background {
            stroke: rgba(0, 0, 0, 0.1);
        }

        .progress-ring .progress {
            stroke: #007AFF;
            stroke-dasharray: 251;
            stroke-dashoffset: 251;
            transition: stroke-dashoffset 0.5s ease;
        }

        .chart-container {
            position: relative;
            height: 180px;
            margin: 20px 0;
        }

        .typing-indicator {
            display: none;
            padding: 8px 16px;
            color: #6e6e73;
            font-style: italic;
            font-size: 14px;
        }

        .typing-indicator.show {
            display: block;
        }

        .quick-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .quick-action {
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.05);
            border: none;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #1d1d1f;
            font-weight: 500;
        }

        .quick-action:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            color: #1d1d1f;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            z-index: 1000;
            border: 1px solid rgba(0, 0, 0, 0.05);
            display: none;
            animation: slideIn 0.3s ease;
        }

        .notification.show {
            display: block;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6e6e73;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .ai-thinking {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6e6e73;
            font-size: 14px;
            font-style: italic;
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #6e6e73;
            animation: thinking 1.4s infinite ease-in-out;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes thinking {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1.2); opacity: 1; }
        }

        .install-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #007AFF;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 122, 255, 0.3);
            z-index: 1000;
            display: none;
            animation: slideUp 0.3s ease;
        }

        .install-banner.show {
            display: block;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .notification-permission {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.2);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .notification-permission.show {
            display: block;
        }

        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1001;
            display: none;
        }

        .offline-indicator.show {
            display: block;
        }

        .system-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 1002;
            max-width: 350px;
            display: none;
        }

        .system-notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        .notification-body {
            color: #6e6e73;
            margin-bottom: 16px;
        }

        .notification-actions {
            display: flex;
            gap: 12px;
        }

        .notification-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .notification-btn.primary {
            background: #007AFF;
            color: white;
        }

        .notification-btn.secondary {
            background: rgba(0, 0, 0, 0.05);
            color: #1d1d1f;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Install Banner -->
    <div class="install-banner" id="installBanner">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div>
                <div style="font-weight: 600; margin-bottom: 4px;">Install FlowState Pro</div>
                <div style="font-size: 14px; opacity: 0.8;">Get the full app experience with notifications</div>
            </div>
            <button class="btn btn-secondary" onclick="installApp()" style="flex-shrink: 0;">Install</button>
            <button class="btn btn-secondary" onclick="dismissInstall()" style="flex-shrink: 0;">√ó</button>
        </div>
    </div>
    
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        üì¥ Offline Mode
    </div>
    
    <!-- System Notification -->
    <div class="system-notification" id="systemNotification">
        <div class="notification-title" id="notificationTitle">Task Reminder</div>
        <div class="notification-body" id="notificationBody">It's time to start your scheduled activity!</div>
        <div class="notification-actions">
            <button class="notification-btn primary" onclick="startTask()">Start Now</button>
            <button class="notification-btn secondary" onclick="snoozeTask()">Snooze 5min</button>
            <button class="notification-btn secondary" onclick="dismissSystemNotification()">Dismiss</button>
        </div>
    </div>
    
    <div class="app-container">
        <!-- App Header -->
        <div class="app-header">
            <div class="app-title">
                <div class="app-logo">FS</div>
                <div>
                    <div class="app-name">FlowState Pro</div>
                    <div class="app-subtitle">Advanced AI Productivity Companion</div>
                </div>
            </div>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>AI Model Active</span>
            </div>
        </div>

        <!-- Notification Permission Banner -->
        <div class="notification-permission" id="notificationBanner">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="font-size: 24px;">üîî</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">Enable Notifications</div>
                    <div style="font-size: 14px; color: #6e6e73;">Get reminders for your scheduled tasks</div>
                </div>
                <button class="btn btn-primary btn-small" onclick="requestNotificationPermission()">Enable</button>
                <button class="btn btn-secondary btn-small" onclick="dismissNotificationBanner()">Later</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Task Creation -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Create New Task</div>
                        <div class="card-subtitle">Add tasks manually or use advanced AI assistance</div>
                    </div>
                    
                    <div class="creation-mode">
                        <label for="creationModeToggle" class="mode-label">Mode:</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="creationModeToggle" name="creationMode" onchange="toggleCreationMode()">
                            <span class="slider"></span>
                        </label>
                        <span id="modeText">Manual</span>
                    </div>

                    <!-- Manual Mode -->
                    <div id="manualMode">
                        <div class="input-group">
                            <label for="taskTitle" class="sr-only">Task Name</label>
                            <input type="text" class="input-field" id="taskTitle" name="taskTitle" placeholder="Task name">
                            
                            <label for="taskTime" class="sr-only">Task Time</label>
                            <input type="time" class="input-field" id="taskTime" name="taskTime" style="flex: 0 0 140px;">
                            
                            <label for="taskDuration" class="sr-only">Task Duration</label>
                            <select class="input-field" id="taskDuration" name="taskDuration" style="flex: 0 0 100px;">
                                <option value="15">15m</option>
                                <option value="30">30m</option>
                                <option value="45">45m</option>
                                <option value="60" selected>1h</option>
                                <option value="90">1.5h</option>
                                <option value="120">2h</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="createTaskManual()">
                            <span>+</span> Create Task
                        </button>
                    </div>

                    <!-- AI Mode -->
                    <div id="aiMode" style="display: none;">
                        <div class="input-group">
                            <label for="aiTaskInput" class="sr-only">AI Task Description</label>
                            <input type="text" class="input-field" id="aiTaskInput" name="aiTaskInput" placeholder="E.g., 'Exercise at 6 PM for 1 hour' or 'Read for 30 minutes at 8 AM'">
                            <button class="btn btn-primary" onclick="createTaskAI()">
                                <span>ü§ñ</span> Create
                            </button>
                        </div>
                        <div id="aiProcessing" class="ai-thinking" style="display: none;">
                            <span>AI is processing your request</span>
                            <div class="thinking-dots">
                                <div class="thinking-dot"></div>
                                <div class="thinking-dot"></div>
                                <div class="thinking-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Tasks -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Today's Tasks</div>
                        <div class="card-subtitle" id="tasksSummary">No tasks scheduled</div>
                    </div>
                    <div id="tasksList"></div>
                </div>

                <!-- Progress Analytics -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Analytics</div>
                        <div class="card-subtitle">Your productivity insights</div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="completionRate">0%</div>
                            <div class="stat-label">Completion</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTime">0h</div>
                            <div class="stat-label">Time Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="streakCount">0</div>
                            <div class="stat-label">Streak</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTasks">0</div>
                            <div class="stat-label">Total Tasks</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- AI Assistant -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">AI Assistant</div>
                        <div class="card-subtitle">Your intelligent productivity coach</div>
                    </div>
                    
                    <div class="ai-chat-container">
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="typing-indicator" id="typingIndicator">AI is thinking...</div>
                        <div class="input-group">
                            <label for="chatInput" class="sr-only">Chat Message</label>
                            <input type="text" class="input-field" id="chatInput" name="chatInput" placeholder="Ask me anything...">
                            <button class="btn btn-primary btn-small" onclick="sendMessage()">Send</button>
                        </div>
                        <div class="quick-actions">
                            <button class="quick-action" onclick="quickAction('progress')">üìä Progress</button>
                            <button class="quick-action" onclick="quickAction('tips')">üí° Tips</button>
                            <button class="quick-action" onclick="quickAction('motivation')">üöÄ Motivate</button>
                        </div>
                    </div>
                </div>

                <!-- Daily Progress -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Daily Progress</div>
                        <div class="card-subtitle">Your productivity overview</div>
                    </div>
                    
                    <div class="progress-ring">
                        <svg>
                            <circle class="background" cx="50" cy="50" r="40"></circle>
                            <circle class="progress" cx="50" cy="50" r="40" id="progressCircle"></circle>
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 20px; font-weight: 600; color: #007AFF;" id="progressPercent">0%</div>
                            <div style="font-size: 12px; color: #6e6e73;">Complete</div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 16px;">
                        <div style="font-size: 16px; font-weight: 500; color: #1d1d1f;" id="dailyMessage">Ready to start!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Enhanced Application State
        let tasks = [];
        let completedTasks = [];
        let isAIMode = false;
        let progressChart = null;

        // Advanced AI Model - Enhanced Natural Language Processing
        class AdvancedFlowStateAI {
            constructor() {
                this.context = [];
                this.userPreferences = {};
                this.learningData = {};
                
                // Enhanced pattern recognition with multiple extraction methods
                this.patterns = {
                    // Task creation patterns with improved flexibility
                    taskCreation: [
                        // Standard patterns
                        /(?:create|add|schedule|make|set up|plan)\s+(?:a\s+)?(?:task|activity|reminder|appointment)?\s*(?:to\s+|for\s+)?([^,]+?)(?:\s+at\s+|\s+from\s+|\s+starting\s+)(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m)(?:\s+for\s+|\s+lasting\s+)?(?:(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr))?/i,
                        
                        // Conversational patterns
                        /(?:i\s+(?:want|need|would like)\s+to\s+|let me\s+|help me\s+)([^,]+?)(?:\s+at\s+|\s+around\s+)(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m)(?:\s+for\s+)?(?:(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr))?/i,
                        
                        // Direct patterns
                        /([^,]+?)\s+(?:at\s+|from\s+|starting\s+)(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m)(?:\s+for\s+)?(?:(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr))?/i,
                        
                        // Time-first patterns
                        /(?:at\s+|from\s+|starting\s+)(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m)(?:\s+(?:i\s+)?(?:want|need|would like)\s+to\s+|,?\s*)([^,]+?)(?:\s+for\s+)?(?:(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr))?/i,
                        
                        // Duration-first patterns
                        /(?:for\s+)?(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr)\s+(?:of\s+)?([^,]+?)(?:\s+at\s+|\s+starting\s+)(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m)/i
                    ],
                    
                    // Progress and analytics patterns
                    progress: [
                        /show\s+(?:my\s+)?progress/i,
                        /how\s+(?:am\s+i\s+|are\s+we\s+)?doing/i,
                        /(?:my\s+)?stats/i,
                        /analytics/i,
                        /report/i,
                        /dashboard/i,
                        /summary/i
                    ],
                    
                    // Tips and advice patterns
                    tips: [
                        /tip/i,
                        /advice/i,
                        /suggest/i,
                        /help.*improve/i,
                        /how.*better/i,
                        /productiv/i,
                        /efficient/i,
                        /optimize/i
                    ],
                    
                    // Motivation patterns
                    motivation: [
                        /motivat/i,
                        /encourag/i,
                        /inspir/i,
                        /boost/i,
                        /cheer/i,
                        /energy/i,
                        /confidence/i
                    ]
                };
            }

            // Enhanced message processing with multiple parsing strategies
            async processMessage(message) {
                console.log('Processing message:', message);
                
                // Add to context for learning
                this.context.push({ message, timestamp: new Date() });
                
                // Try task creation first
                const taskResult = await this.attemptTaskCreation(message);
                if (taskResult.success) {
                    return taskResult.response;
                }
                
                // Check for other intents
                for (let pattern of this.patterns.progress) {
                    if (pattern.test(message)) {
                        return this.generateProgressReport();
                    }
                }
                
                for (let pattern of this.patterns.tips) {
                    if (pattern.test(message)) {
                        return this.generateTip();
                    }
                }
                
                for (let pattern of this.patterns.motivation) {
                    if (pattern.test(message)) {
                        return this.generateMotivation();
                    }
                }
                
                // Default conversational response
                return this.generateConversationalResponse(message);
            }

            // Enhanced task creation with multiple parsing attempts
            async attemptTaskCreation(message) {
                console.log('Attempting task creation for:', message);
                
                for (let pattern of this.patterns.taskCreation) {
                    const match = message.match(pattern);
                    if (match) {
                        console.log('Pattern matched:', pattern, 'Match:', match);
                        
                        const taskData = this.extractTaskData(match, message);
                        if (taskData.activity && taskData.time) {
                            const success = this.createTask(taskData);
                            if (success) {
                                return {
                                    success: true,
                                    response: `‚úÖ **Task Created Successfully!**\n\nüìã **Activity:** ${taskData.activity}\n‚è∞ **Time:** ${taskData.time}\n‚è±Ô∏è **Duration:** ${taskData.duration} minutes\n\nYour task is now in your schedule and you'll be reminded when it's time to start! üéØ`
                                };
                            }
                        }
                    }
                }
                
                // If no pattern matches, try alternative extraction
                const alternativeResult = this.tryAlternativeExtraction(message);
                if (alternativeResult.success) {
                    return alternativeResult;
                }
                
                return {
                    success: false,
                    response: null
                };
            }

            // Enhanced data extraction with improved parsing
            extractTaskData(match, originalMessage) {
                console.log('Extracting task data from match:', match);
                
                let activity = '';
                let time = '';
                let duration = 60; // Default duration
                
                // Different extraction strategies based on match groups
                if (match.length >= 3) {
                    // Standard pattern: activity, time, duration
                    activity = match[1] ? match[1].trim() : '';
                    time = match[2] ? match[2].trim() : '';
                    duration = match[3] ? this.parseDuration(match[3]) : 60;
                } else if (match.length >= 2) {
                    // Simpler pattern: activity, time
                    activity = match[1] ? match[1].trim() : '';
                    time = match[2] ? match[2].trim() : '';
                }
                
                // Clean up activity name
                activity = this.cleanActivityName(activity);
                
                // Parse and normalize time
                if (time) {
                    time = this.parseTime(time);
                }
                
                // Validate duration
                if (duration < 5) duration = 15; // Minimum 15 minutes
                if (duration > 480) duration = 120; // Maximum 8 hours
                
                console.log('Extracted data:', { activity, time, duration });
                
                return { activity, time, duration };
            }

            // Alternative extraction for edge cases
            tryAlternativeExtraction(message) {
                console.log('Trying alternative extraction for:', message);
                
                // Look for time patterns anywhere in the message
                const timeMatches = message.match(/(\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m)/gi);
                const durationMatches = message.match(/(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr)/gi);
                
                if (timeMatches && timeMatches.length > 0) {
                    const time = this.parseTime(timeMatches[0]);
                    let duration = 60;
                    
                    if (durationMatches && durationMatches.length > 0) {
                        duration = this.parseDuration(durationMatches[0]);
                    }
                    
                    // Try to extract activity by removing time and duration references
                    let activity = message
                        .replace(/(?:create|add|schedule|make|set up|plan)\s+(?:a\s+)?(?:task|activity|reminder|appointment)?\s*(?:to\s+|for\s+)?/i, '')
                        .replace(/\d{1,2}(?::\d{2})?(?:\s*[ap]m)?|\d{1,2}\s*[ap]m/gi, '')
                        .replace(/\d+\s*(?:min|minute|minutes|hour|hours|h|hr)/gi, '')
                        .replace(/(?:at|from|starting|for|lasting)\s+/gi, '')
                        .trim();
                    
                    activity = this.cleanActivityName(activity);
                    
                    if (activity && time) {
                        const success = this.createTask({ activity, time, duration });
                        if (success) {
                            return {
                                success: true,
                                response: `‚úÖ **Task Created!**\n\nüìã **Activity:** ${activity}\n‚è∞ **Time:** ${time}\n‚è±Ô∏è **Duration:** ${duration} minutes\n\nI've added this to your schedule! üéØ`
                            };
                        }
                    }
                }
                
                return { success: false };
            }

            // Improved activity name cleaning
            cleanActivityName(activity) {
                if (!activity) return '';
                
                // Remove common filler words
                activity = activity
                    .replace(/^(to\s+|for\s+|i\s+want\s+to\s+|i\s+need\s+to\s+|let\s+me\s+|help\s+me\s+)/i, '')
                    .replace(/\s+(at|from|starting|for|lasting)\s+.*$/i, '')
                    .trim();
                
                // Capitalize first letter
                activity = activity.charAt(0).toUpperCase() + activity.slice(1);
                
                // If empty or too short, provide default
                if (activity.length < 2) {
                    activity = 'New Task';
                }
                
                return activity;
            }

            // Enhanced time parsing with better format support
            parseTime(timeStr) {
                console.log('Parsing time:', timeStr);
                
                if (!timeStr) return '';
                
                const cleanTime = timeStr.replace(/\s+/g, '').toLowerCase();
                
                // Handle 24-hour format
                if (cleanTime.includes(':')) {
                    const parts = cleanTime.split(':');
                    if (parts.length === 2) {
                        let hour = parseInt(parts[0]);
                        let minute = parseInt(parts[1].replace(/[^\d]/g, ''));
                        
                        // Handle AM/PM
                        if (cleanTime.includes('pm') && hour !== 12) {
                            hour += 12;
                        } else if (cleanTime.includes('am') && hour === 12) {
                            hour = 0;
                        }
                        
                        return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    }
                }
                
                // Handle 12-hour format without colon
                const match = cleanTime.match(/(\d{1,2})(am|pm)/);
                if (match) {
                    let hour = parseInt(match[1]);
                    const period = match[2];
                    
                    if (period === 'pm' && hour !== 12) {
                        hour += 12;
                    } else if (period === 'am' && hour === 12) {
                        hour = 0;
                    }
                    
                    return `${hour.toString().padStart(2, '0')}:00`;
                }
                
                return timeStr;
            }

            // Enhanced duration parsing
            parseDuration(durationStr) {
                console.log('Parsing duration:', durationStr);
                
                if (!durationStr) return 60;
                
                const match = durationStr.match(/(\d+)\s*(?:min|minute|minutes|hour|hours|h|hr)/i);
                if (match) {
                    const value = parseInt(match[1]);
                    const unit = match[0].toLowerCase();
                    
                    if (unit.includes('hour') || unit.includes('hr') || unit.includes('h')) {
                        return value * 60;
                    }
                    return value;
                }
                
                return 60;
            }

            // Create task with proper validation
            createTask(taskData) {
                console.log('Creating task with data:', taskData);
                
                if (!taskData.activity || !taskData.time) {
                    console.log('Invalid task data - missing activity or time');
                    return false;
                }
                
                const newTask = {
                    id: Date.now(),
                    title: taskData.activity,
                    time: taskData.time,
                    duration: taskData.duration,
                    completed: false,
                    createdAt: new Date(),
                    createdBy: 'AI'
                };
                
                console.log('New task created:', newTask);
                
                tasks.push(newTask);
                this.updateUI();
                showNotification(`‚úÖ Task created: ${taskData.activity} at ${taskData.time}`);
                
                return true;
            }

            // Update UI after task creation
            updateUI() {
                console.log('Updating UI with tasks:', tasks);
                renderTasks();
                updateStats();
                updateProgressChart();
                updateProgressRing();
            }

            // Enhanced progress reporting
            generateProgressReport() {
                const today = new Date().toDateString();
                const todayTasks = tasks.filter(t => t.createdAt.toDateString() === today);
                const completedToday = todayTasks.filter(t => t.completed).length;
                const totalToday = todayTasks.length;
                const completionRate = totalToday > 0 ? Math.round((completedToday / totalToday) * 100) : 0;
                
                let report = `üìä **Your Progress Report**\n\n`;
                report += `üìù **Today's Tasks:** ${completedToday}/${totalToday}\n`;
                report += `üìà **Completion Rate:** ${completionRate}%\n`;
                report += `‚è±Ô∏è **Time Spent:** ${this.calculateTotalTime()} minutes\n`;
                report += `üî• **Current Streak:** ${this.getStreak()} days\n\n`;
                
                if (completionRate >= 90) {
                    report += `üåü **Outstanding!** You're absolutely crushing your goals today!`;
                } else if (completionRate >= 75) {
                    report += `üéØ **Excellent work!** You're having a very productive day!`;
                } else if (completionRate >= 50) {
                    report += `üí™ **Good progress!** You're on the right track!`;
                } else if (completionRate >= 25) {
                    report += `üöÄ **Getting started!** Keep building that momentum!`;
                } else {
                    report += `‚ú® **Fresh start!** Today is full of possibilities!`;
                }
                
                return report;
            }

            // Enhanced tip generation
            generateTip() {
                const tips = [
                    "üéØ **Focus Strategy:** Use the Pomodoro Technique - 25 minutes focused work, 5 minutes break.",
                    "‚ö° **Energy Management:** Schedule your most important tasks during your peak energy hours.",
                    "üîÑ **Habit Building:** Start with just 2 minutes a day to build lasting habits.",
                    "üì± **Digital Minimalism:** Keep your phone in another room during deep work sessions.",
                    "üß† **Mental Clarity:** Take regular breaks to prevent mental fatigue and maintain focus.",
                    "üé® **Environment Design:** Create a dedicated workspace that signals 'focus time' to your brain.",
                    "üìù **Planning Power:** Spend 10 minutes each evening planning tomorrow's top 3 priorities.",
                    "üåÖ **Morning Routine:** Start your day with 10 minutes of intention setting and planning."
                ];
                
                return tips[Math.floor(Math.random() * tips.length)];
            }

            // Enhanced motivation generation
            generateMotivation() {
                const motivations = [
                    "üî• **You're unstoppable!** Every task you complete is building the future you want!",
                    "üíé **Growth mindset activated!** You're not just checking boxes, you're building character!",
                    "üåü **Progress champion!** Small consistent actions create extraordinary results!",
                    "üöÄ **Momentum master!** You're creating positive energy that compounds over time!",
                    "‚ö° **Excellence in action!** Your commitment to growth is truly inspiring!",
                    "üéØ **Goal crusher!** You're turning dreams into reality, one task at a time!",
                    "üí™ **Discipline builder!** Every completed task strengthens your willpower muscle!",
                    "üåà **Future creator!** You're actively designing the life you want to live!"
                ];
                
                return motivations[Math.floor(Math.random() * motivations.length)];
            }

            // Enhanced conversational responses
            generateConversationalResponse(message) {
                const responses = [
                    "I'm here to help you stay productive and achieve your goals! Try asking me to create a task, show your progress, or give you some tips.",
                    "Let's make today amazing! I can help you schedule tasks, track your progress, or provide motivation when you need it.",
                    "I'm your intelligent productivity partner! What would you like to work on today?",
                    "Ready to boost your productivity? I can create tasks from natural language, analyze your progress, or provide personalized advice!"
                ];
                
                return responses[Math.floor(Math.random() * responses.length)];
            }

            // Helper methods
            calculateTotalTime() {
                const today = new Date().toDateString();
                return completedTasks
                    .filter(t => t.completedAt && t.completedAt.toDateString() === today)
                    .reduce((total, t) => total + (t.duration || 0), 0);
            }

            getStreak() {
                const today = new Date().toDateString();
                const todayCompleted = completedTasks.filter(t => 
                    t.completedAt && t.completedAt.toDateString() === today
                ).length;
                return todayCompleted > 0 ? Math.min(todayCompleted, 10) : 0;
            }
        }

        // Initialize advanced AI
        const ai = new AdvancedFlowStateAI();

        // UI Functions
        function toggleCreationMode() {
            isAIMode = !isAIMode;
            const modeText = document.getElementById('modeText');
            const manualMode = document.getElementById('manualMode');
            const aiMode = document.getElementById('aiMode');
            
            if (isAIMode) {
                modeText.textContent = 'AI Assistant';
                manualMode.style.display = 'none';
                aiMode.style.display = 'block';
            } else {
                modeText.textContent = 'Manual';
                manualMode.style.display = 'block';
                aiMode.style.display = 'none';
            }
        }

        function createTaskManual() {
            const title = document.getElementById('taskTitle').value.trim();
            const time = document.getElementById('taskTime').value;
            const duration = parseInt(document.getElementById('taskDuration').value);
            
            if (!title || !time) {
                showNotification('‚ùå Please fill in all fields');
                return;
            }
            
            const newTask = {
                id: Date.now(),
                title: title,
                time: time,
                duration: duration,
                completed: false,
                createdAt: new Date(),
                createdBy: 'Manual'
            };
            
            tasks.push(newTask);
            
            // Clear inputs
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskTime').value = '';
            
            renderTasks();
            updateStats();
            updateProgressChart();
            updateProgressRing();
            showNotification('‚úÖ Task created successfully!');
        }

        async function createTaskAI() {
            const input = document.getElementById('aiTaskInput');
            const message = input.value.trim();
            
            if (!message) {
                showNotification('‚ùå Please enter a task description');
                return;
            }
            
            // Show processing indicator
            const processingDiv = document.getElementById('aiProcessing');
            processingDiv.style.display = 'flex';
            
            // Add user message to chat
            addChatMessage(message, 'user');
            
            // Clear input immediately
            input.value = '';
            
            try {
                // Process with advanced AI
                const response = await ai.processMessage(message);
                addChatMessage(response, 'ai');
                
                // Hide processing indicator
                processingDiv.style.display = 'none';
                
            } catch (error) {
                console.error('AI processing error:', error);
                addChatMessage('I apologize, but I encountered an error processing your request. Please try again.', 'ai');
                processingDiv.style.display = 'none';
            }
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            const summary = document.getElementById('tasksSummary');
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div>No tasks yet. Create your first task above!</div>
                    </div>
                `;
                summary.textContent = 'No tasks scheduled';
                return;
            }
            
            const today = new Date().toDateString();
            const todayTasks = tasks.filter(t => t.createdAt.toDateString() === today);
            const completedToday = todayTasks.filter(t => t.completed).length;
            
            summary.textContent = `${completedToday}/${todayTasks.length} completed today`;
            
            container.innerHTML = '';
            
            // Sort tasks by time
            const sortedTasks = [...tasks].sort((a, b) => a.time.localeCompare(b.time));
            
            sortedTasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskElement.innerHTML = `
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})"></div>
                    <div class="task-info">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">${task.time} ‚Ä¢ ${task.duration} min ${task.createdBy ? '‚Ä¢ ' + task.createdBy : ''}</div>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-secondary btn-small" onclick="removeTask(${task.id})">Remove</button>
                    </div>
                `;
                container.appendChild(taskElement);
            });
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                
                if (task.completed) {
                    completedTasks.push({
                        ...task,
                        completedAt: new Date()
                    });
                    showNotification('üéâ Task completed!');
                    addChatMessage('üéâ Excellent work! Task completed successfully!', 'system');
                } else {
                    completedTasks = completedTasks.filter(t => t.id !== id);
                }
                
                renderTasks();
                updateStats();
                updateProgressChart();
                updateProgressRing();
            }
        }

        function removeTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            completedTasks = completedTasks.filter(t => t.id !== id);
            renderTasks();
            updateStats();
            updateProgressChart();
            updateProgressRing();
            showNotification('üóëÔ∏è Task removed');
        }

        function updateStats() {
            const today = new Date().toDateString();
            const todayTasks = tasks.filter(t => t.createdAt.toDateString() === today);
            const completedToday = todayTasks.filter(t => t.completed).length;
            const totalToday = todayTasks.length;
            const completionRate = totalToday > 0 ? Math.round((completedToday / totalToday) * 100) : 0;
            const totalTime = Math.round(ai.calculateTotalTime() / 60 * 10) / 10;
            const streak = ai.getStreak();
            
            document.getElementById('completionRate').textContent = `${completionRate}%`;
            document.getElementById('totalTime').textContent = `${totalTime}h`;
            document.getElementById('streakCount').textContent = streak;
            document.getElementById('totalTasks').textContent = totalToday;
        }

        function updateProgressChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            if (progressChart) {
                progressChart.destroy();
            }
            
            // Generate data for the past 7 days
            const data = [];
            const labels = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                
                const dayTasks = tasks.filter(t => 
                    t.createdAt.toDateString() === date.toDateString() && t.completed
                ).length;
                data.push(dayTasks);
            }
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Completed Tasks',
                        data: data,
                        borderColor: '#007AFF',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#007AFF',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#6e6e73',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6e6e73',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateProgressRing() {
            const today = new Date().toDateString();
            const todayTasks = tasks.filter(t => t.createdAt.toDateString() === today);
            const completedToday = todayTasks.filter(t => t.completed).length;
            const totalToday = todayTasks.length;
            const percentage = totalToday > 0 ? (completedToday / totalToday) * 100 : 0;
            
            const circle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 40;
            const offset = circumference - (percentage / 100) * circumference;
            
            circle.style.strokeDashoffset = offset;
            document.getElementById('progressPercent').textContent = `${Math.round(percentage)}%`;
            
            const messageElement = document.getElementById('dailyMessage');
            if (percentage >= 100) {
                messageElement.textContent = "Perfect day! üéâ";
            } else if (percentage >= 80) {
                messageElement.textContent = "Almost there! üåü";
            } else if (percentage >= 50) {
                messageElement.textContent = "Great progress! üí™";
            } else if (percentage > 0) {
                messageElement.textContent = "Keep going! üöÄ";
            } else {
                messageElement.textContent = "Ready to start! ‚ú®";
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage(message, 'user');
            
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.classList.add('show');
            
            try {
                const response = await ai.processMessage(message);
                typingIndicator.classList.remove('show');
                addChatMessage(response, 'ai');
            } catch (error) {
                console.error('Chat error:', error);
                typingIndicator.classList.remove('show');
                addChatMessage('I apologize, but I encountered an error. Please try again.', 'ai');
            }
            
            input.value = '';
        }

        function addChatMessage(message, sender) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            
            if (sender === 'ai') {
                div.innerHTML = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            } else {
                div.textContent = message;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function quickAction(action) {
            const actions = {
                'progress': 'Show my progress report',
                'tips': 'Give me a productivity tip',
                'motivation': 'I need some motivation'
            };
            
            const input = document.getElementById('chatInput');
            input.value = actions[action];
            sendMessage();
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // PWA Installation
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBanner').classList.add('show');
        });
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('App installed');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBanner').classList.remove('show');
                });
            }
        }
        
        function dismissInstall() {
            document.getElementById('installBanner').classList.remove('show');
        }
        
        // Notification Management
        let notificationPermission = false;
        
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationPermission = true;
                        localStorage.setItem('notificationPermission', 'granted');
                        dismissNotificationBanner();
                        showNotification('üéâ Notifications enabled! You\'ll now get task reminders.');
                    } else {
                        showNotification('‚ùå Notifications blocked. Enable them in browser settings for task reminders.');
                    }
                });
            }
        }
        
        function dismissNotificationBanner() {
            document.getElementById('notificationBanner').classList.remove('show');
        }

        function startTask() {
            const notification = document.getElementById('systemNotification');
            const taskId = notification.dataset.taskId;
            if (taskId) {
                startTaskById(parseInt(taskId));
            }
            dismissSystemNotification();
        }
        
        function snoozeTask() {
            const notification = document.getElementById('systemNotification');
            const taskId = notification.dataset.taskId;
            if (taskId) {
                const task = tasks.find(t => t.id === parseInt(taskId));
                if (task) {
                    setTimeout(() => showTaskNotification(task), 5 * 60 * 1000);
                }
            }
            dismissSystemNotification();
        }
        
        function dismissSystemNotification() {
            document.getElementById('systemNotification').classList.remove('show');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            renderTasks();
            updateStats();
            updateProgressChart();
            updateProgressRing();
            
            // Check notification permission
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    notificationPermission = true;
                } else if (Notification.permission === 'default') {
                    document.getElementById('notificationBanner').classList.add('show');
                }
            }
            
            // Add welcome message
            setTimeout(() => {
                addChatMessage("üëã Welcome to FlowState Pro! I'm your advanced AI productivity companion with enhanced natural language processing. I can understand complex requests like 'Exercise at 6 PM for 1 hour' or 'Help me read for 30 minutes at 8 AM'. Try the AI mode for intelligent task creation!", 'ai');
            }, 1000);
            
            // Enable Enter key for chat
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Enable Enter key for AI task creation
            document.getElementById('aiTaskInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    createTaskAI();
                }
            });
        });
    </script>
</body>
</html>
