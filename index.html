<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowState Pro - AI Productivity Companion</title>
    <meta name="description" content="Your Apple-inspired AI productivity companion with task management, voice AI, and app integrations">
    
    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <meta name="theme-color" content="#007AFF">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #F2F2F7;
            --bg-secondary: rgba(255, 255, 255, 0.85);
            --text-primary: #1D1D1F;
            --text-secondary: #6E6E73;
            --primary-color: #007AFF;
            --success-color: #34C759;
            --danger-color: #FF3B30;
            --border-color: rgba(60, 60, 67, 0.1);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --card-bg: rgba(255, 255, 255, 0.92);
            --sidebar-bg: rgba(242, 242, 247, 0.95);
        }

        [data-theme="dark"] {
            --bg-primary: #1C1C1E;
            --bg-secondary: rgba(28, 28, 30, 0.9);
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --primary-color: #0A84FF;
            --border-color: rgba(84, 84, 88, 0.3);
            --card-bg: rgba(28, 28, 30, 0.92);
            --sidebar-bg: rgba(28, 28, 30, 0.95);
        }

        [data-theme="elegant"] {
            --bg-primary: linear-gradient(135deg, #5856D6 0%, #007AFF 100%);
            --primary-color: #5856D6;
            --text-primary: #FFFFFF;
            --text-secondary: #D1D1D6;
            --card-bg: rgba(255, 255, 255, 0.9);
            --sidebar-bg: rgba(88, 86, 214, 0.95);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            max-width: 1600px;
            margin: 16px auto;
            gap: 16px;
        }

        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 16px;
            height: calc(100vh - 32px);
            overflow-y: auto;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .app-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), #5856D6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .app-name {
            font-size: 24px;
            font-weight: 700;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary-color);
            color: white;
        }

        .main-content {
            flex: 1;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-modal.hidden {
            display: none;
        }

        .auth-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-input {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
        }

        .auth-btn {
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .auth-error {
            color: var(--danger-color);
            font-size: 13px;
            margin-top: 8px;
            min-height: 20px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .chat-messages {
            height: 240px;
            overflow-y: auto;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }

        .message {
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            max-width: 80%;
            font-size: 14px;
        }

        .message.user {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
        }

        .message.ai {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .voice-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .voice-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .voice-btn.listening {
            background: var(--danger-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .integrations-section {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .integration-btn {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .integration-btn.connected {
            background: var(--success-color);
            color: white;
        }

        .tracksheet-upload {
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
        }

        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }
            .card {
                padding: 16px;
            }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Authentication Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-content">
            <h2 id="authTitle">Welcome to FlowState Pro</h2>
            <p id="authSubtitle">Sign in to your account</p>
            <form class="auth-form" id="authForm">
                <input type="text" class="auth-input" id="nameInput" placeholder="Full Name" style="display: none;">
                <input type="email" class="auth-input" id="emailInput" placeholder="Email Address" required>
                <input type="password" class="auth-input" id="passwordInput" placeholder="Password" required>
                <input type="password" class="auth-input" id="confirmPasswordInput" placeholder="Confirm Password" style="display: none;">
                <button type="submit" class="auth-btn" id="authSubmitBtn">Sign In</button>
                <div class="auth-error" id="authError"></div>
            </form>
            <p style="margin-top: 16px; font-size: 13px;">
                <span id="authSwitchText">Don't have an account?</span>
                <a href="#" id="authSwitchLink" onclick="toggleAuthMode()">Sign Up</a>
            </p>
            <button class="btn btn-secondary" onclick="signInWithGoogle()" style="margin-top: 12px; width: 100%;">Sign in with Google</button>
            <button class="btn btn-secondary" onclick="signInWithMicrosoft()" style="margin-top: 8px; width: 100%;">Sign in with Microsoft</button>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-logo">FS</div>
                <div class="app-name">FlowState Pro</div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item active" data-section="dashboard">📊 Dashboard</div>
                <div class="nav-item" data-section="tasks">📋 Tasks</div>
                <div class="nav-item" data-section="assistant">🧠 AI Assistant</div>
                <div class="nav-item" data-section="integrations">🔗 Integrations</div>
                <div class="nav-item" data-section="settings">⚙️ Settings</div>
                <div class="nav-item" onclick="userManager.logout()">🚪 Sign Out</div>
            </div>
            <div class="user-profile" style="margin-top: auto; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                <div class="user-avatar" id="userAvatar">U</div>
                <div id="userName">User</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div class="section" id="dashboard-section">
                <div class="card">
                    <div class="card-title">Welcome, <span id="welcomeName">User</span>!</div>
                    <div class="card-subtitle">Your AI productivity companion</div>
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-style: italic; font-size: 16px; margin-bottom: 8px;" id="quoteText">"The way to get started is to quit talking and begin doing."</div>
                        <div style="font-weight: 500; color: var(--primary-color);" id="quoteAuthor">— Walt Disney</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Daily Progress</div>
                        <div style="text-align: center; padding: 16px;">
                            <div style="width: 80px; height: 80px; margin: 0 auto; position: relative;">
                                <svg style="width: 100%; height: 100%; transform: rotate(-90deg);">
                                    <circle cx="40" cy="40" r="32" fill="none" stroke="var(--border-color)" stroke-width="5"></circle>
                                    <circle cx="40" cy="40" r="32" fill="none" stroke="var(--primary-color)" stroke-width="5" stroke-dasharray="201" stroke-dashoffset="201" id="progressCircle"></circle>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div style="font-size: 16px; font-weight: 600; color: var(--primary-color);" id="progressPercent">0%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Complete</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Section -->
            <div class="section hidden" id="tasks-section">
                <div class="card">
                    <div class="card-title">Smart Task Creator</div>
                    <div class="card-subtitle">Create tasks with AI and voice support</div>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <input type="text" class="input-field" id="taskInput" placeholder="Describe your task...">
                        <button class="btn btn-primary" onclick="createTask()">Create</button>
                    </div>
                    <div class="tracksheet-upload">
                        <input type="file" id="tracksheetInput" accept=".pdf,.jpg,.png" style="display: none;">
                        <button class="btn btn-secondary" onclick="document.getElementById('tracksheetInput').click()">📄 Upload Tracksheet</button>
                        <div id="uploadStatus" style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Today's Tasks</div>
                    <div class="card-subtitle" id="tasksSummary">No tasks yet</div>
                    <div id="tasksList"></div>
                </div>
            </div>

            <!-- AI Assistant Section -->
            <div class="section hidden" id="assistant-section">
                <div class="card">
                    <div class="card-title">Ultra AI Assistant</div>
                    <div class="card-subtitle">Your personal AI coach</div>
                    <div class="voice-controls">
                        <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">🎤</button>
                        <select id="voiceGender" onchange="updateVoice()">
                            <option value="female">Female Voice</option>
                            <option value="male">Male Voice</option>
                        </select>
                        <div id="voiceStatus">Voice ready</div>
                    </div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="input-field" id="chatInput" placeholder="Ask me anything...">
                        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="quickAction('progress')">📊 Progress</button>
                        <button class="btn btn-secondary" onclick="quickAction('tips')">💡 Tips</button>
                        <button class="btn btn-secondary" onclick="quickAction('motivation')">🚀 Motivate</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Ask Your Doubts</div>
                    <div class="card-subtitle">Get instant help with AI</div>
                    <textarea class="input-field" id="doubtInput" placeholder="Ask any question..." style="height: 80px; resize: vertical;"></textarea>
                    <div style="margin-top: 12px;">
                        <button class="btn btn-primary" onclick="resolveDoubt()">🧠 Get AI Help</button>
                    </div>
                    <div id="doubtResponse" style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; display: none;"></div>
                </div>
            </div>

            <!-- Integrations Section -->
            <div class="section hidden" id="integrations-section">
                <div class="card">
                    <div class="card-title">App Integrations</div>
                    <div class="card-subtitle">Connect your favorite tools</div>
                    <div class="integrations-section">
                        <button class="integration-btn" id="zoomBtn" onclick="connectApp('zoom')">📹 Zoom</button>
                        <button class="integration-btn" id="teamsBtn" onclick="connectApp('teams')">💬 Teams</button>
                        <button class="integration-btn" id="googleCalendarBtn" onclick="connectApp('googleCalendar')">📅 Google Calendar</button>
                        <button class="integration-btn" id="outlookBtn" onclick="connectApp('outlook')">📧 Outlook</button>
                        <button class="integration-btn" id="slackBtn" onclick="connectApp('slack')">📢 Slack</button>
                    </div>
                    <div id="integrationStatus" style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);"></div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="section hidden" id="settings-section">
                <div class="card">
                    <div class="card-title">Settings</div>
                    <div class="card-subtitle">Customize your experience</div>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button class="btn btn-secondary active" onclick="setTheme('light')">Light</button>
                        <button class="btn btn-secondary" onclick="setTheme('dark')">Dark</button>
                        <button class="btn btn-secondary" onclick="setTheme('elegant')">Elegant</button>
                    </div>
                    <div>
                        <label style="font-size: 13px; color: var(--text-secondary);">Subscription</label>
                        <div style="margin-top: 8px;">
                            <button class="btn btn-primary" onclick="upgradePlan()">🚀 Upgrade to Premium</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        // REPLACE WITH YOUR FIREBASE CONFIG FROM FIREBASE CONSOLE
        // 1. Go to Firebase Console > Project Settings > General > Your apps > Add app > Web
        // 2. Copy the config object here
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            document.getElementById('authError').textContent = 'App configuration error. Please contact support.';
        }
        const auth = firebase.auth();

        // Application State
        let currentUser = null;
        let tasks = [];
        let isLoggedIn = false;
        let isListening = false;
        let selectedVoice = null;
        let recognition = null;
        let integrations = {
            zoom: false,
            teams: false,
            googleCalendar: false,
            outlook: false,
            slack: false
        };

        // Famous Quotes
        const quotes = {
            motivation: [
                { text: "The way to get started is to quit talking and begin doing.", author: "Walt Disney" },
                { text: "Innovation distinguishes between a leader and a follower.", author: "Steve Jobs" },
                { text: "Success is not final, failure is not fatal.", author: "Winston Churchill" }
            ],
            superhero: [
                { text: "With great power comes great responsibility.", author: "Spider-Man (Uncle Ben)" },
                { text: "I am vengeance, I am the night, I am Batman.", author: "Batman" }
            ]
        };

        // User Management
        class UserManager {
            constructor() {
                this.currentUser = null;
                auth.onAuthStateChanged(user => {
                    if (user) {
                        this.currentUser = {
                            id: user.uid,
                            name: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            tasks: JSON.parse(localStorage.getItem(`tasks-${user.uid}`) || '[]'),
                            preferences: JSON.parse(localStorage.getItem(`prefs-${user.uid}`) || '{"theme":"light","voice":"female"}')
                        };
                        this.login(this.currentUser);
                    } else {
                        this.showAuth();
                    }
                }, error => {
                    console.error('Auth state change error:', error);
                    document.getElementById('authError').textContent = 'Authentication service unavailable.';
                });
            }

            showAuth() {
                document.getElementById('authModal').classList.remove('hidden');
                document.getElementById('authError').textContent = '';
            }

            hideAuth() {
                document.getElementById('authModal').classList.add('hidden');
            }

            async loginWithEmail(email, password) {
                if (!email || !password) {
                    document.getElementById('authError').textContent = 'Please enter both email and password.';
                    return;
                }
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    this.login({
                        id: userCredential.user.uid,
                        name: userCredential.user.displayName || email.split('@')[0],
                        email: userCredential.user.email,
                        tasks: JSON.parse(localStorage.getItem(`tasks-${userCredential.user.uid}`) || '[]'),
                        preferences: JSON.parse(localStorage.getItem(`prefs-${userCredential.user.uid}`) || '{"theme":"light","voice":"female"}')
                    });
                } catch (error) {
                    document.getElementById('authError').textContent = this.formatAuthError(error);
                }
            }

            async register(name, email, password, confirmPassword) {
                if (!name || !email || !password) {
                    document.getElementById('authError').textContent = 'Please fill in all fields.';
                    return;
                }
                if (password !== confirmPassword) {
                    document.getElementById('authError').textContent = 'Passwords do not match.';
                    return;
                }
                if (password.length < 6) {
                    document.getElementById('authError').textContent = 'Password must be at least 6 characters.';
                    return;
                }
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName: name });
                    const user = {
                        id: userCredential.user.uid,
                        name,
                        email,
                        tasks: [],
                        preferences: { theme: 'light', voice: 'female' }
                    };
                    localStorage.setItem(`prefs-${user.id}`, JSON.stringify(user.preferences));
                    this.login(user);
                } catch (error) {
                    document.getElementById('authError').textContent = this.formatAuthError(error);
                }
            }

            async signInWithGoogle() {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('email');
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    document.getElementById('authError').textContent = this.formatAuthError(error);
                }
            }

            async signInWithMicrosoft() {
                try {
                    const provider = new firebase.auth.OAuthProvider('microsoft.com');
                    provider.addScope('User.Read');
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    document.getElementById('authError').textContent = this.formatAuthError(error);
                }
            }

            formatAuthError(error) {
                console.error('Auth error:', error.code, error.message);
                switch (error.code) {
                    case 'auth/invalid-email':
                        return 'Invalid email address.';
                    case 'auth/user-not-found':
                        return 'No account found with this email.';
                    case 'auth/wrong-password':
                        return 'Incorrect password.';
                    case 'auth/email-already-in-use':
                        return 'Email already in use.';
                    case 'auth/weak-password':
                        return 'Password must be at least 6 characters.';
                    case 'auth/invalid-credential':
                        return 'Invalid credentials provided.';
                    case 'auth/network-request-failed':
                        return 'Network error. Please check your connection.';
                    case 'auth/popup-blocked':
                        return 'Popup blocked. Please allow popups for this site.';
                    case 'auth/too-many-requests':
                        return 'Too many attempts. Please try again later.';
                    default:
                        return 'Authentication failed: ' + error.message;
                }
            }

            login(user) {
                this.currentUser = user;
                currentUser = user;
                isLoggedIn = true;
                tasks = user.tasks || [];
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
                document.getElementById('welcomeName').textContent = user.name;
                this.hideAuth();
                renderTasks();
                setTheme(user.preferences.theme);
                document.getElementById('voiceGender').value = user.preferences.voice;
                updateVoice();
                addChatMessage(`Welcome, ${user.name}! Let's make today productive!`, 'ai');
                speakText(`Welcome back, ${user.name}! Ready to crush it?`);
            }

            logout() {
                auth.signOut().catch(error => {
                    console.error('Logout error:', error);
                });
                localStorage.removeItem(`tasks-${this.currentUser.id}`);
                localStorage.removeItem(`prefs-${this.currentUser.id}`);
                window.location.reload();
            }

            saveData() {
                if (this.currentUser) {
                    localStorage.setItem(`tasks-${this.currentUser.id}`, JSON.stringify(tasks));
                    localStorage.setItem(`prefs-${this.currentUser.id}`, JSON.stringify(this.currentUser.preferences));
                }
            }
        }

        const userManager = new UserManager();

        // Voice Management
        function initVoice() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('voiceBtn').classList.add('listening');
                    document.getElementById('voiceStatus').textContent = 'Listening...';
                };
                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('voiceBtn').classList.remove('listening');
                    document.getElementById('voiceStatus').textContent = 'Voice ready';
                };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    processVoiceCommand(transcript);
                };
                recognition.onerror = (event) => {
                    document.getElementById('voiceStatus').textContent = 'Voice recognition error';
                    console.error(event.error);
                };
            }
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = updateVoiceOptions;
                updateVoiceOptions();
            }
        }

        function updateVoiceOptions() {
            const voices = speechSynthesis.getVoices();
            const genderPref = document.getElementById('voiceGender').value;
            selectedVoice = voices.find(voice => {
                const name = voice.name.toLowerCase();
                return genderPref === 'female' ? 
                    name.includes('female') || name.includes('samantha') || name.includes('karen') :
                    name.includes('male') || name.includes('daniel') || name.includes('alex');
            }) || voices[0];
        }

        function speakText(text) {
            if ('speechSynthesis' in window && selectedVoice) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = selectedVoice;
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        function toggleVoice() {
            if (!recognition) {
                document.getElementById('voiceStatus').textContent = 'Voice not supported';
                return;
            }
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function processVoiceCommand(command) {
            document.getElementById('voiceStatus').textContent = `Heard: "${command}"`;
            if (command.toLowerCase().includes('create') || command.toLowerCase().includes('task')) {
                document.getElementById('taskInput').value = command;
                createTask();
            } else if (command.toLowerCase().includes('progress')) {
                quickAction('progress');
            } else {
                document.getElementById('chatInput').value = command;
                sendMessage();
            }
        }

        function updateVoice() {
            updateVoiceOptions();
            if (currentUser) {
                currentUser.preferences.voice = document.getElementById('voiceGender').value;
                userManager.saveData();
            }
        }

        // Tracksheet Parsing
        async function parseTracksheet(file) {
            document.getElementById('uploadStatus').textContent = 'Processing...';
            try {
                const { data: { text } } = await Tesseract.recognize(file, 'eng');
                const tasksExtracted = extractTasksFromText(text);
                tasks.push(...tasksExtracted);
                renderTasks();
                userManager.saveData();
                document.getElementById('uploadStatus').textContent = `Added ${tasksExtracted.length} tasks`;
                speakText(`Added ${tasksExtracted.length} tasks from your tracksheet.`);
            } catch (error) {
                document.getElementById('uploadStatus').textContent = 'Error processing file';
                console.error(error);
            }
        }

        function extractTasksFromText(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const tasks = [];
            lines.forEach(line => {
                const match = line.match(/(.+?)(?:\s*-\s*(\d{1,2}:\d{2}\s*(?:am|pm))?)/i);
                if (match) {
                    tasks.push({
                        id: Date.now() + tasks.length,
                        title: match[1].trim(),
                        time: match[2] || '09:00',
                        completed: false,
                        createdAt: new Date()
                    });
                }
            });
            return tasks;
        }

        // Integrations
        async function connectApp(app) {
            try {
                let provider;
                switch (app) {
                    case 'zoom':
                        provider = new firebase.auth.OAuthProvider('oidc.zoom');
                        break;
                    case 'teams':
                    case 'outlook':
                        provider = new firebase.auth.OAuthProvider('microsoft.com');
                        provider.addScope('User.Read');
                        break;
                    case 'googleCalendar':
                        provider = new firebase.auth.GoogleAuthProvider();
                        provider.addScope('email');
                        break;
                    case 'slack':
                        provider = new firebase.auth.OAuthProvider('oidc.slack');
                        break;
                }
                await auth.signInWithPopup(provider);
                integrations[app] = true;
                updateIntegrationStatus();
                document.getElementById('integrationStatus').textContent = `${app} connected`;
                syncTasksWithApp(app);
            } catch (error) {
                document.getElementById('integrationStatus').textContent = `Failed to connect ${app}: ${userManager.formatAuthError(error)}`;
                console.error(error);
            }
        }

        async function syncTasksWithApp(app) {
            const callable = firebase.functions().httpsCallable('syncTasks');
            try {
                const result = await callable({ app, tasks });
                addChatMessage(`Synced ${result.data.count} tasks with ${app}`, 'ai');
                speakText(`Synced tasks with ${app}.`);
            } catch (error) {
                console.error(`Sync failed for ${app}:`, error);
            }
        }

        function updateIntegrationStatus() {
            Object.keys(integrations).forEach(app => {
                const btn = document.getElementById(`${app}Btn`);
                btn.classList.toggle('connected', integrations[app]);
                btn.textContent = integrations[app] ? `✅ ${app}` : `🔗 ${app}`;
            });
        }

        // AI Assistant
        class AIAssistant {
            constructor() {
                this.motivationIndex = 0;
            }

            async processMessage(message) {
                if (this.isTaskRequest(message)) {
                    return this.handleTaskCreation(message);
                }
                if (message.toLowerCase().includes('progress')) {
                    return this.getProgressReport();
                }
                if (message.toLowerCase().includes('tip')) {
                    return this.getProductivityTip();
                }
                if (message.toLowerCase().includes('motivat')) {
                    return this.getMotivation();
                }
                return this.getGeneralResponse(message);
            }

            isTaskRequest(message) {
                return /create|add|schedule|task|remind/i.test(message);
            }

            handleTaskCreation(message) {
                const task = this.extractTaskFromMessage(message);
                if (task.title) {
                    tasks.push(task);
                    renderTasks();
                    userManager.saveData();
                    const quote = this.getRandomQuote('motivation');
                    return `✅ Task "${task.title}" created for ${task.time}!\n\n💡 "${quote.text}" — ${quote.author}`;
                }
                return "Please provide more task details.";
            }

            extractTaskFromMessage(message) {
                const title = message.replace(/create|add|schedule|task|remind me to/gi, '').trim() || 'New Task';
                const timeMatch = message.match(/(\d{1,2}:\d{2}|\d{1,2}\s*(am|pm))/i);
                const time = timeMatch ? timeMatch[0] : '09:00';
                return {
                    id: Date.now(),
                    title: title.charAt(0).toUpperCase() + title.slice(1),
                    time: time,
                    completed: false,
                    createdAt: new Date()
                };
            }

            getProgressReport() {
                const completed = tasks.filter(t => t.completed).length;
                const total = tasks.length;
                const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
                return `📊 Progress: ${completed}/${total} tasks\n📈 ${rate}%\n\n${this.getMotivationalMessage(rate)}`;
            }

            getProductivityTip() {
                const tips = [
                    "🎯 Do quick tasks immediately if they take under 2 minutes.",
                    "⚡ Schedule tough tasks for your peak energy hours.",
                    "🔄 Use time-blocking to stay focused.",
                    "📱 Keep distractions away during work sessions.",
                    "🧠 Take short breaks to recharge."
                ];
                return tips[Math.floor(Math.random() * tips.length)];
            }

            getMotivation() {
                const motivations = [
                    `🌟 ${currentUser?.name || 'Champion'}, you're unstoppable!`,
                    `💪 Keep pushing, ${currentUser?.name || 'Achiever'}!`,
                    `🚀 ${currentUser?.name || 'Star'}, shine bright today!`
                ];
                this.motivationIndex = (this.motivationIndex + 1) % motivations.length;
                return motivations[this.motivationIndex];
            }

            getMotivationalMessage(rate) {
                if (rate >= 80) return `🎉 Amazing work, ${currentUser?.name || 'Champion'}!`;
                if (rate >= 40) return `💪 Solid progress, ${currentUser?.name || 'Fighter'}!`;
                return `🚀 Keep going, ${currentUser?.name || 'Explorer'}!`;
            }

            getGeneralResponse(message) {
                return `Hey ${currentUser?.name || 'friend'}, I'm here to boost your productivity! What's next?`;
            }

            getRandomQuote(category) {
                const quoteArray = quotes[category] || quotes.motivation;
                return quoteArray[Math.floor(Math.random() * quoteArray.length)];
            }

            displayQuote(category = 'motivation') {
                const quote = this.getRandomQuote(category);
                document.getElementById('quoteText').textContent = `"${quote.text}"`;
                document.getElementById('quoteAuthor').textContent = `— ${quote.author}`;
            }
        }

        const aiAssistant = new AIAssistant();

        // Doubt Resolution
        async function resolveDoubt() {
            const question = document.getElementById('doubtInput').value.trim();
            if (!question) return;
            const response = document.getElementById('doubtResponse');
            response.style.display = 'block';
            response.innerHTML = '<div>🤔 Thinking...</div>';
            setTimeout(() => {
                response.innerHTML = `
                    <div style="line-height: 1.5; font-size: 14px;">
                        <strong>🧠 AI Response:</strong><br>
                        For "<em>${question}</em>":<br>
                        Here's a simplified explanation to help you understand.<br>
                        <strong>Tip:</strong> Try breaking it down and practicing daily.<br>
                        <em>💡 Keep learning, ${currentUser?.name || 'student'}!</em>
                    </div>
                `;
                speakText('I found an answer to your question.');
            }, 1500);
        }

        // UI Functions
        function toggleAuthMode() {
            const isLogin = document.getElementById('authTitle').textContent.includes('Sign In');
            document.getElementById('authTitle').textContent = isLogin ? 'Create Account' : 'Sign In';
            document.getElementById('nameInput').style.display = isLogin ? 'block' : 'none';
            document.getElementById('confirmPasswordInput').style.display = isLogin ? 'block' : 'none';
            document.getElementById('authSubmitBtn').textContent = isLogin ? 'Create Account' : 'Sign In';
            document.getElementById('authSwitchText').textContent = isLogin ? 'Already have an account?' : "Don't have an account?";
            document.getElementById('authSwitchLink').textContent = isLogin ? 'Sign In' : 'Sign Up';
            document.getElementById('authError').textContent = '';
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            addChatMessage(message, 'user');
            input.value = '';
            const response = await aiAssistant.processMessage(message);
            addChatMessage(response, 'ai');
            speakText(response.replace(/[🎯💪🚀⚡🌟📊✅📈🔄📱🧠]/g, ''));
        }

        function addChatMessage(message, sender) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.innerHTML = message.replace(/\n/g, '<br>');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function createTask() {
            const input = document.getElementById('taskInput');
            const message = input.value.trim();
            if (!message) return;
            input.value = '';
            addChatMessage(message, 'user');
            const response = aiAssistant.handleTaskCreation(message);
            addChatMessage(response, 'ai');
            speakText(`Task created! ${aiAssistant.getMotivation()}`);
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            const summary = document.getElementById('tasksSummary');
            if (tasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 32px; color: var(--text-secondary);"><div style="font-size: 40px; margin-bottom: 8px;">📝</div><div>Create your first task!</div></div>';
                summary.textContent = 'No tasks yet';
                updateProgress();
                return;
            }
            const completed = tasks.filter(t => t.completed).length;
            summary.textContent = `${completed}/${tasks.length} completed`;
            container.innerHTML = '';
            tasks.forEach(task => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;';
                div.innerHTML = `
                    <div style="width: 18px; height: 18px; border: 2px solid var(--primary-color); border-radius: 50%; cursor: pointer; ${task.completed ? 'background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center;' : ''}" onclick="toggleTask(${task.id})">
                        ${task.completed ? '✓' : ''}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">${task.title}</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">${task.time}</div>
                    </div>
                    <button onclick="removeTask(${task.id})" style="padding: 6px 12px; background: var(--danger-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">Remove</button>
                `;
                container.appendChild(div);
            });
            updateProgress();
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    const quote = aiAssistant.getRandomQuote('superhero');
                    addChatMessage(`🎉 Task done! "${quote.text}" — ${quote.author}`, 'ai');
                    speakText(`Great job, ${currentUser?.name}! ${quote.text}`);
                }
                renderTasks();
                userManager.saveData();
            }
        }

        function removeTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            renderTasks();
            userManager.saveData();
        }

        function updateProgress() {
            const completed = tasks.filter(t => t.completed).length;
            const total = tasks.length;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            const circle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 32;
            circle.style.strokeDashoffset = circumference - (percentage / 100) * circumference;
            document.getElementById('progressPercent').textContent = `${Math.round(percentage)}%`;
        }

        function quickAction(type) {
            const actions = {
                progress: 'Show my progress report',
                tips: 'Give me a productivity tip',
                motivation: 'I need motivation'
            };
            document.getElementById('chatInput').value = actions[type];
            sendMessage();
        }

        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.querySelectorAll('.btn-secondary').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === theme);
            });
            if (currentUser) {
                currentUser.preferences.theme = theme;
                userManager.saveData();
            }
        }

        function upgradePlan() {
            window.open('https://checkout.stripe.com/...', '_blank'); // REPLACE WITH YOUR STRIPE CHECKOUT URL
        }

        // Authentication Handlers
        document.getElementById('authForm').addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            const isRegister = document.getElementById('nameInput').style.display !== 'none';
            const name = document.getElementById('nameInput').value.trim();
            const confirmPassword = document.getElementById('confirmPasswordInput').value.trim();
            document.getElementById('authError').textContent = '';

            if (isRegister) {
                await userManager.register(name, email, password, confirmPassword);
            } else {
                await userManager.loginWithEmail(email, password);
            }
        });

        async function signInWithGoogle() {
            await userManager.signInWithGoogle();
        }

        async function signInWithMicrosoft() {
            await userManager.signInWithMicrosoft();
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initVoice();
            aiAssistant.displayQuote();
            document.getElementById('chatInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') sendMessage();
            });
            document.getElementById('taskInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') createTask();
            });
            document.getElementById('tracksheetInput').addEventListener('change', e => {
                if (e.target.files[0]) parseTracksheet(e.target.files[0]);
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
                    document.getElementById(`${item.dataset.section}-section`).classList.remove('hidden');
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                });
            });
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    reg.update();
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                const banner = document.createElement('div');
                                banner.innerHTML = `
                                    <div style="position: fixed; bottom: 16px; left: 16px; right: 16px; background: var(--primary-color); color: white; padding: 12px; border-radius: 8px; text-align: center; z-index: 9999;">
                                        🆕 Update available! 
                                        <button onclick="updateApp()" style="margin-left: 8px; padding: 6px 12px; background: white; color: var(--primary-color); border: none; border-radius: 6px; font-weight: 500;">Update</button>
                                    </div>
                                `;
                                document.body.appendChild(banner);
                            }
                        });
                    });
                    navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
                }).catch(err => console.error('Service Worker registration failed:', err));
            });
        }

        function updateApp() {
            navigator.serviceWorker.getRegistration().then(reg => {
                if (reg && reg.waiting) {
                    reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                }
            });
        }
    </script>
</body>
</html>
